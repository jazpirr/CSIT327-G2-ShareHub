{# templates/admin/approve_requests.html #}
{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Approve Requests · Admin{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/approve-request.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/solid.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/fontawesome.min.css">
{% endblock %}

{% block content %}
<div class="approve-requests-container">
  <div class="requests-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-check-circle title-icon"></i>
        Approve Requests
      </h1>
      <p class="page-subtitle">Review and respond to pending borrow requests</p>
    </div>
    <div class="header-actions">
      <div class="requests-count">
        <span class="count-badge">{{ pending_requests|length }}</span>
        <span class="count-label">Pending Requests</span>
      </div>
    </div>
  </div>

  <div class="requests-stats-grid">
    <div class="stat-card primary-stat">
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ pending_requests|length }}</div>
        <div class="stat-label">Pending Requests</div>
        <div class="stat-trend">Awaiting review</div>
      </div>
    </div>

    <div class="stat-card success-stat">
      <div class="stat-icon">
        <i class="fas fa-check-double"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">0</div>
        <div class="stat-label">Approved Today</div>
        <div class="stat-trend">Ready for pickup</div>
      </div>
    </div>

    <div class="stat-card warning-stat">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">0</div>
        <div class="stat-label">Require Attention</div>
        <div class="stat-trend">Special handling needed</div>
      </div>
    </div>
  </div>

  <div class="requests-table-section">
    <div class="table-header">
      <div class="table-title">
        <h3><i class="fas fa-list-check"></i> Pending Borrow Requests</h3>
      </div>
      <p>Review and take action on pending item requests</p>
    </div>

    <div class="table-wrapper">
      {% if pending_requests %}
      <div class="requests-grid">
        {% for r in pending_requests %}
        <div class="request-card" data-request-id="{{ r.request_id }}">
          <div class="request-header">
            <div class="request-meta">
              <span class="request-id">Request #{{ forloop.counter }}</span>
              <span class="request-date">{{ r.request_date }}</span>
            </div>
          </div>

          <div class="request-content">
            <div class="item-info">
              <h4 class="item-title">{{ r.item_title }}</h4>
              <p class="item-category">General Item</p>
            </div>
            
            <div class="requester-info">
              <div class="user-avatar">
                {{ r.requester_name|slice:":1"|upper }} 
              </div>
              <div class="user-details">
                <span class="user-name">{{ r.requester_name }}</span>
                <span class="user-role">Requester</span>
              </div>
            </div>
          </div>

          <div class="request-actions">
            <button class="action-btn approve-btn" data-action="approve">
              <i class="fas fa-check"></i>
              Approve
            </button>
            <button class="action-btn deny-btn" data-action="deny">
              <i class="fas fa-times"></i>
              Deny
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3>No Pending Requests</h3>
        <p>All borrow requests have been processed. Check back later for new requests.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div id="notificationContainer"></div>
{% endblock %}


{% block scripts %}



<!-- FULL postRespond SCRIPT -->
<script>
/* Approve Requests page - unified AJAX handler for admin actions
   Works with your current markup (.approve-btn/.deny-btn and data-action) 
   and also supports .btn-approve/.btn-deny if you choose to reuse external JS later.
*/

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const CSRF_TOKEN = getCookie('csrftoken') || '{{ csrf_token }}';

async function postRespond(request_id, action) {
  try {
    const card = document.querySelector(`.request-card[data-request-id="${request_id}"]`);
    if (!card) {
      console.warn("postRespond: card not found for", request_id);
      return;
    }

    card.classList.add('processing');
    card.querySelectorAll('.action-btn, .btn-approve, .btn-deny').forEach(btn => btn.disabled = true);

    const url = "{% url 'api_respond_request' %}";
    const payload = { request_id: request_id, action: action };

    const resp = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(payload)
    });

    // read raw response first (safe if server returned HTML)
    let text = null;
    let data = null;
    try {
      text = await resp.text();
      data = text ? JSON.parse(text) : null;
    } catch (err) {
      data = null;
    }

    console.groupCollapsed(`respond_request ${request_id} -> ${action} (status ${resp.status})`);
    console.log('REQUEST PAYLOAD:', payload);
    console.log('RESPONSE RAW:', text);
    console.log('RESPONSE JSON:', data);
    console.groupEnd();

    // unauthorized or forbidden
    if (resp.status === 401) {
      showNotification((data?.errors?.general?.[0]?.message) || 'Not authenticated', 'error');
      resetCard(card);
      return;
    }
    if (resp.status === 403) {
      showNotification((data?.errors?.general?.[0]?.message) || 'Permission denied', 'error');
      resetCard(card);
      return;
    }

    if (!resp.ok) {
      const serverMessage = (data?.message) || (data?.errors?.general?.[0]?.message) || text || `Server error (${resp.status})`;
      showNotification('Failed: ' + serverMessage, 'error');
      resetCard(card);
      return;
    }

    if (data && data.success) {
      card.classList.add('completed');
      setTimeout(() => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(-20px)';
        setTimeout(() => card.remove(), 300);
        updatePendingCount();
        if (data.overwritten) {
          showNotification('Admin overwrote previous decision — status changed.', 'success');
        } else {
          showNotification(action === 'approve' ? 'Request approved!' : 'Request denied!', 'success');
        }
      }, 400);
      return;
    }

    // fallback: server returned 200 but success is false / no JSON
    resetCard(card);
    showNotification('Failed: ' + ((data && (data.message || (data.errors && data.errors.general && data.errors.general[0].message))) || 'Unknown error'), 'error');

  } catch (e) {
    console.error('postRespond exception:', e);
    showNotification('Network error occurred', 'error');
  }
}

function resetCard(card) {
  card.classList.remove('processing');
  card.querySelectorAll('.action-btn, .btn-approve, .btn-deny').forEach(btn => btn.disabled = false);
}

function updatePendingCount() {
  const remainingCards = document.querySelectorAll('.request-card').length;
  document.querySelectorAll('.stat-value, .count-badge').forEach(el => { el.textContent = remainingCards; });
}

// Lightweight notification helper (keeps your existing behavior)
function showNotification(message, type = 'info') {
  const n = document.createElement('div');
  n.className = `notification ${type}`;
  n.innerHTML = `<span>${message}</span><button class="close-notification">&times;</button>`;
  (document.getElementById('notificationContainer') || document.body).appendChild(n);
  setTimeout(() => n.classList.add('show'), 50);
  setTimeout(() => { n.classList.remove('show'); setTimeout(()=>n.remove(), 250); }, 5000);
  n.querySelector('.close-notification').addEventListener('click', () => { n.remove(); });
}

// Wire up clicks for your admin page. This supports both class naming conventions.
document.addEventListener('DOMContentLoaded', () => {
  // existing admin classes: .approve-btn / .deny-btn
  document.querySelectorAll('.approve-btn, .deny-btn, .btn-approve, .btn-deny').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const button = e.currentTarget;
      // get request id either from data-request-id attribute on button OR from the containing card
      const card = button.closest('.request-card');
      const requestId = button.dataset.requestId || (card && card.getAttribute('data-request-id'));
      const action = button.dataset.action || (button.classList.contains('approve-btn') || button.classList.contains('btn-approve') ? 'approve' : 'deny');
      if (!requestId) {
        console.warn('No request id found for action button', button);
        return;
      }
      postRespond(requestId, action);
    });
  });
});
</script>



{% endblock %}
