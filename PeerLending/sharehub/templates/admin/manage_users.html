{# templates/admin/manage_users.html #}
{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Manage Users · Admin{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/manage-users.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="manage-users-container">
  <!-- Page Header -->
  <div class="users-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-users title-icon"></i>
        Manage Users
      </h1>
      <p class="page-subtitle">Control user permissions and access levels</p>
    </div>
    <div class="header-actions">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" placeholder="Search users..." class="search-input" id="search-users">
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div id="user-messages" aria-live="polite" class="messages-container"></div>

  <!-- Statistics Cards -->
  <div class="users-stats-grid">
    <div class="stat-card total-users-stat">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="total-users-count">0</div>
        <div class="stat-label">Total Users</div>
        <div class="stat-trend">All registered users</div>
      </div>
    </div>

    <div class="stat-card admin-stat">
      <div class="stat-icon">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value admin-count" id="admin-users-count">0</div>
        <div class="stat-label">Administrators</div>
        <div class="stat-trend">System administrators</div>
      </div>
    </div>

    <div class="stat-card blocked-stat">
      <div class="stat-icon">
        <i class="fas fa-user-slash"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value blocked-count" id="blocked-users-count">0</div>
        <div class="stat-label">Blocked Users</div>
        <div class="stat-trend">Restricted access</div>
      </div>
    </div>

    <div class="stat-card active-stat">
      <div class="stat-icon">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="active-users-count">0</div>
        <div class="stat-label">Active Users</div>
        <div class="stat-trend">Currently active</div>
      </div>
    </div>
  </div>

  <!-- Users Table Section -->
  <div class="users-table-section">
    <div class="table-header">
      <div class="table-title">
        <h3><i class="fas fa-user-cog"></i> User Management</h3>
        <div class="table-filters">
          <div class="filter-group">
            <label>Role:</label>
            <select class="filter-select" id="role-filter">
              <option value="all">All Roles</option>
              <option value="admin">Administrators</option>
              <option value="user">Regular Users</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Status:</label>
            <select class="filter-select" id="status-filter">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="blocked">Blocked</option>
            </select>
          </div>
        </div>
      </div>
      <p>Manage user permissions and account status</p>
    </div>

    <div class="table-wrapper">
      {% if users %}
      <div class="users-grid">
        {% for u in users %}
        <div class="user-card" data-user-id="{{ u.id }}">
          <div class="user-header">
            <div class="user-avatar-large">
              {% if u.profile_picture %}
                <img src="{{ u.profile_picture }}" alt="{{ u.display_name }}" loading="lazy">
              {% else %}
                {{ u.display_name|default:u.email|slice:":1"|upper }}
              {% endif %}
            </div>
            <div class="user-badges">
              {% if u.is_admin %}
              <span class="badge admin-badge">
                <i class="fas fa-shield-alt"></i>
                Admin
              </span>
              {% endif %}
              {% if u.is_block %}
              <span class="badge blocked-badge">
                <i class="fas fa-user-slash"></i>
                Blocked
              </span>
              {% else %}
              <span class="badge active-badge">
                <i class="fas fa-check-circle"></i>
                Active
              </span>
              {% endif %}
            </div>
          </div>

          <div class="user-info">
            <h4 class="user-name">{{ u.display_name|default:u.email|escape }}</h4>
            <p class="user-email">{{ u.email|default:"No email"|escape }}</p>

          </div>

          <div class="user-actions">
            <button class="action-btn admin-toggle-btn {% if u.is_admin %}demote{% else %}promote{% endif %}" 
                    data-user-id="{{ u.id }}" 
                    title="{% if u.is_admin %}Demote from admin{% else %}Promote to admin{% endif %}">
              <i class="fas fa-shield-alt"></i>
              {{ u.is_admin|yesno:"Demote,Promote" }}
            </button>

            <button class="action-btn block-toggle-btn {% if u.is_block %}unblock{% else %}block{% endif %}" 
                    data-user-id="{{ u.id }}" 
                    title="{% if u.is_block %}Unblock user{% else %}Block user{% endif %}">
              {% if u.is_block %}
                <i class="fas fa-user-check"></i>
                Unblock
              {% else %}
                <i class="fas fa-user-slash"></i>
                Block
              {% endif %}
            </button>

            <button class="action-btn details-btn" data-user-id="{{ u.id }}" title="View user details">
              <i class="fas fa-eye"></i>
              Details
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-users"></i>
        </div>
        <h3>No Users Found</h3>
        <p>There are no users to display. Users will appear here once they register.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div id="user-details-modal" class="modal hidden" role="dialog" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-panel" role="document" aria-labelledby="user-details-title">
    <header class="modal-header">
      <h3 id="user-details-title"><i class="fas fa-user-circle"></i> User Details</h3>
      <button id="close-user-details" class="modal-close" aria-label="Close">&times;</button>
    </header>

    <div class="modal-body">
      <div class="user-summary-row">
        <div class="user-profile">
          <div class="user-avatar-large" id="ud-avatar">
            <!-- avatar/image will be injected -->
          </div>
          <div class="user-profile-info">
            <div id="ud-name" class="profile-name"></div>
            <div id="ud-email" class="profile-email"></div>
            <div class="profile-stats">
              <span id="ud-total-owned" class="stat-item">Owned: 0</span>
              <span id="ud-total-borrowed" class="stat-item">Borrowed: 0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-sections">
        <section class="modal-section">
          <h4><i class="fas fa-box"></i> Items Owned</h4>
          <div id="ud-items-owned" class="items-grid">Loading…</div>
        </section>

        <section class="modal-section">
          <h4><i class="fas fa-handshake"></i> Items Borrowed / Requests</h4>
          <div id="ud-items-borrowed" class="items-grid">Loading…</div>
        </section>
      </div>
    </div>

    <footer class="modal-footer">
      <button id="close-user-details-2" class="btn btn-secondary">Close</button>
    </footer>
  </div>
</div>
{% endblock %}

{% block scripts %}
{# safe JSON for JS to consume #}
{{ users_json|json_script:"users-data" }}

<script>
  // set globals *before* external script loads
  window.CSRF_TOKEN = "{{ csrf_token }}";
  window.TOGGLE_ADMIN_URL = "{% url 'toggle_user_admin' %}";
  window.TOGGLE_BLOCK_URL = "{% url 'toggle_user_block' %}";
  window.ADMIN_USER_DETAILS_URL = "{% url 'admin_user_details_api' %}";
</script>

<script defer src="{% static 'js/manage_users.js' %}"></script>
{% endblock %}