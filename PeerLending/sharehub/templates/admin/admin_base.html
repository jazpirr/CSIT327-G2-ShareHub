<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Admin Â· ShareHub{% endblock %}</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/admin_shared.css' %}">
  <link rel="stylesheet" href="{% static 'css/header.css' %}?v=3">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  {% block head_extra %}{% endblock %}
</head>

<body data-color-scheme="light">

  <!-- Admin Header - Using same structure as user header -->
  <nav class="navbar">
    <nav class="navbar admin-nav">
      <div class="nav-container">
        <div class="nav-left">
          <a href="{% url 'admin_dashboard' %}" class="logo">
            <div class="logo-wrapper">
              <i class="fas fa-hands-helping logo-icon"></i>
            </div>
            <span class="logo-text">
              <span class="share-text">Share</span>
              <span class="hub-text">Hub</span>
            </span>
          </a>
        </div>

        <div class="nav-center">
          <a href="{% url 'admin_dashboard' %}"
            class="nav-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-text">Home</span>
          </a>
          <a href="{% url 'approve_requests' %}"
            class="nav-link {% if request.resolver_match.url_name == 'approve_requests' %}active{% endif %}">
            <i class="fas fa-check-circle nav-icon"></i>
            <span class="nav-text">Approve Requests</span>
          </a>
          <a href="{% url 'manage_users' %}"
            class="nav-link {% if request.resolver_match.url_name == 'manage_users' %}active{% endif %}">
            <i class="fas fa-user-cog nav-icon"></i>
            <span class="nav-text">Manage Users</span>
          </a>
          <a href="{% url 'admin_reports' %}"
            class="nav-link {% if request.resolver_match.url_name == 'admin_reports' %}active{% endif %}">
            <i class="fas fa-chart-bar nav-icon"></i>
            <span class="nav-text">View Reports</span>
          </a>

          <a href="{% url 'admin_all_items' %}"
            class="nav-link {% if request.resolver_match.url_name == 'admin_all_items' %}active{% endif %}">
              <i class="fas fa-boxes nav-icon"></i>
              <span class="nav-text">All Items</span>
          </a>
        </div>

        <div class="nav-right">
          <div class="profile-dropdown">
            <button class="profile-trigger" type="button" id="profileTrigger">
              <div class="profile-avatar">
                <i class="fas fa-user-shield"></i>
              </div>
            </button>

            <div class="profile-menu" id="profileMenu">
              <div class="profile-info">
                <div class="profile-name">
                  Administrator
                </div>
                <div class="profile-email">admin@sharehub.edu</div>
              </div>

              <div class="profile-menu-divider"></div>

              <form action="{% url 'logout' %}" method="POST" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="profile-menu-item logout">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </nav>

  <!-- Overlay for dropdowns -->
  <div id="profileOverlay" class="notification-overlay" aria-hidden="true"></div>

  </div>

  <main class="admin-main">
    {% block content %}{% endblock %}
  </main>

  <script>
    window.APP = window.APP || {};
    window.APP.CSRF_TOKEN = "{{ csrf_token }}";
    window.APP.URLS = {
      approveRequests: "{% url 'approve_requests' %}",
      manageUsers: "{% url 'manage_users' %}",
      viewReports: "{% url 'admin_reports' %}",
      dashboard: "{% url 'admin_dashboard' %}"
    };
  </script>

  <script>
    // Profile dropdown functionality
    document.addEventListener('DOMContentLoaded', function () {
      const profileTrigger = document.getElementById('profileTrigger');
      const profileDropdown = document.querySelector('.profile-dropdown');
      const profileMenu = document.getElementById('profileMenu');
      const profileOverlay = document.getElementById('profileOverlay');

      function openProfile() {
        profileDropdown.classList.add('active');
        profileOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeProfile() {
        profileDropdown.classList.remove('active');
        profileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      if (profileTrigger) {
        profileTrigger.addEventListener('click', function (e) {
          e.stopPropagation();
          if (profileDropdown.classList.contains('active')) {
            closeProfile();
          } else {
            openProfile();
          }
        });
      }

      profileOverlay.addEventListener('click', closeProfile);

      document.addEventListener('click', function (e) {
        if (!profileDropdown.contains(e.target) && !profileTrigger.contains(e.target)) {
          closeProfile();
        }
      });

      // Position profile menu correctly
      const profileTriggerBtn = document.getElementById('profileTrigger');
      const profileMenuEl = document.getElementById('profileMenu');

      function positionProfileMenu() {
        if (!profileTriggerBtn || !profileMenuEl) return;

        profileMenuEl.style.left = '';
        profileMenuEl.style.right = '';
        profileMenuEl.style.maxWidth = '';

        const menuRect = profileMenuEl.getBoundingClientRect();
        const triggerRect = profileTriggerBtn.getBoundingClientRect();
        const viewportWidth = document.documentElement.clientWidth;

        if (menuRect.right > viewportWidth - 8) {
          const leftPos = Math.max(8, triggerRect.right - menuRect.width);
          profileMenuEl.style.left = `${leftPos}px`;
          profileMenuEl.style.right = 'auto';
        } else {
          profileMenuEl.style.right = '0';
          profileMenuEl.style.left = 'auto';
        }

        if (menuRect.width > viewportWidth - 24) {
          profileMenuEl.style.maxWidth = `${viewportWidth - 24}px`;
          const newRect = profileMenuEl.getBoundingClientRect();
          if (newRect.right > viewportWidth - 8) {
            profileMenuEl.style.left = `${Math.max(8, triggerRect.right - newRect.width)}px`;
            profileMenuEl.style.right = 'auto';
          }
        }
      }

      profileTriggerBtn?.addEventListener('click', function () {
        setTimeout(positionProfileMenu, 50);
      });

      window.addEventListener('resize', positionProfileMenu);
      window.addEventListener('orientationchange', positionProfileMenu);
      window.addEventListener('scroll', positionProfileMenu, true);

      // Notification functionality (optional)
      const notificationBtn = document.querySelector('.notification-btn');
      const notificationPopup = document.getElementById('notificationPopup');
      const notificationOverlay = document.getElementById('notificationOverlay');
      const closePopupBtn = document.getElementById('closePopup');
      const markReadBtn = document.getElementById('markAllReadBtn');

      function openNotifications() {
        notificationPopup.classList.add('active');
        notificationOverlay.classList.add('active');
        notificationBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }

      function closeNotifications() {
        notificationPopup.classList.remove('active');
        notificationOverlay.classList.remove('active');
        notificationBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      if (notificationBtn) {
        notificationBtn.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();

          if (notificationPopup.classList.contains('active')) {
            closeNotifications();
          } else {
            openNotifications();
          }
        }, true);
      }

      if (closePopupBtn) {
        closePopupBtn.addEventListener('click', closeNotifications);
      }

      notificationOverlay.addEventListener('click', closeNotifications);

      if (markReadBtn) {
        markReadBtn.addEventListener('click', function () {
          const unreadItems = document.querySelectorAll('.notification-item.unread');
          unreadItems.forEach(item => {
            item.classList.remove('unread');
          });

          const badge = document.getElementById('notificationBadge');
          if (badge) {
            badge.style.display = 'none';
          }
        });
      }

      // Scroll effect for navbar
      let lastScrollTop = 0;
      const navbar = document.querySelector('.navbar');

      window.addEventListener('scroll', function () {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (scrollTop > 50) {
          navbar.classList.add('scrolled');
        } else {
          navbar.classList.remove('scrolled');
        }

        lastScrollTop = scrollTop;
      });

      // Close on escape key
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          closeProfile();
          closeNotifications();
        }
      });
    });
  </script>

  {% block scripts %}{% endblock %}
  <div id="errorOverlay" class="popup-overlay" aria-hidden="true"></div>

<div id="errorPopup" class="shared-popup" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="shared-popup-inner" tabindex="-1">
    
    <h2 id="popupHeader">Message</h2>
    <div id="popupBody"></div>
  </div>
</div>

  <script>
(function () {
  // Safe element references
  const popup = document.getElementById('errorPopup');
  const overlay = document.getElementById('errorOverlay');
  const header = document.getElementById('popupHeader');
  const body = document.getElementById('popupBody');
  const closeBtn = popup && popup.querySelector('.close-btn');
  let autoCloseTimer = null;
  let _confirmResolve = null;
  let _lastTrigger = null;

  // Inline SVG icons
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
    warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
  };

  function showOverlay() {
    if (!overlay) return;
    overlay.style.display = 'flex';
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    overlay.style.pointerEvents = 'auto';
  }
  function hideOverlay() {
    if (!overlay) return;
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
    overlay.style.pointerEvents = 'none';
    setTimeout(()=> { if (overlay) overlay.style.display = 'none'; }, 220);
  }

  function showPopupContainer(typeClass) {
    if (!popup) return;
    popup.style.display = 'flex';
    popup.classList.add('show');
    if (typeClass) popup.classList.add(`popup-${typeClass}`);
    popup.setAttribute('aria-hidden', 'false');
    popup.style.pointerEvents = 'auto';
    // focus the popup content for accessibility
    const inner = popup.querySelector('.shared-popup-inner');
    if (inner && typeof inner.focus === 'function') inner.focus();
  }

  function hidePopupContainer() {
    if (!popup) return;
    // clear type classes
    popup.classList.remove('popup-success','popup-error','popup-warning','popup-info');
    popup.classList.remove('show');
    popup.setAttribute('aria-hidden', 'true');
    popup.style.pointerEvents = 'none';
    setTimeout(() => {
      if (popup) popup.style.display = 'none';
      if (body) body.innerHTML = '';
    }, 220);
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Public: show message popup
  window.showMessagePopup = function (title, message, opts = {}) {
    const { autoCloseMs = 3000, type = 'info' } = opts || {};
    // clear previous
    if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
    // remove previous classes
    if (popup) popup.classList.remove('popup-success','popup-error','popup-warning','popup-info');
    // set title
    if (header) header.textContent = title || 'Message';
    // create body
    const icon = icons[type] || icons.info;
    if (body) {
      body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;text-align:center;gap:14px;">
          <div class="popup-message-icon">${icon}</div>
          <div class="popup-message">${escapeHtml(String(message))}</div>
        </div>
      `;
    }
    // show
    showOverlay();
    showPopupContainer(type);
    // auto close
    if (autoCloseMs && autoCloseMs > 0) {
      autoCloseTimer = setTimeout(()=> {
        hidePopupContainer();
        hideOverlay();
      }, autoCloseMs);
      // return focus after auto close
      setTimeout(()=> { if (_lastTrigger && typeof _lastTrigger.focus === 'function') _lastTrigger.focus(); _lastTrigger = null; }, autoCloseMs + 50);
    }
  };

  // Public: confirm popup returns Promise<boolean>
  window.showConfirmPopup = function (title, message, yesLabel = 'Yes', noLabel = 'Cancel') {
    return new Promise((resolve) => {
      // cleanup any previous
      if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
      if (!body || !header) {
        // fallback
        const ok = confirm(message);
        resolve(ok);
        return;
      }
      header.textContent = title || 'Confirm';
      body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px;">
          <div class="popup-message">${escapeHtml(String(message))}</div>
          <div class="popup-buttons">
            <button id="__popupNoBtn" class="popup-secondary">${escapeHtml(noLabel)}</button>
            <button id="__popupYesBtn" class="popup-primary">${escapeHtml(yesLabel)}</button>
          </div>
        </div>
      `;
      showOverlay();
      showPopupContainer();
      // attach listeners
      const yesBtn = document.getElementById('__popupYesBtn');
      const noBtn = document.getElementById('__popupNoBtn');

      function cleanup(result) {
        if (yesBtn) yesBtn.removeEventListener('click', onYes);
        if (noBtn) noBtn.removeEventListener('click', onNo);
        hidePopupContainer();
        hideOverlay();
        resolve(result);
        // return focus
        if (_lastTrigger && typeof _lastTrigger.focus === 'function') _lastTrigger.focus();
        _lastTrigger = null;
      }
      function onYes() { cleanup(true); }
      function onNo() { cleanup(false); }

      if (yesBtn) yesBtn.addEventListener('click', onYes);
      if (noBtn) noBtn.addEventListener('click', onNo);

      // focus yes after short delay
      setTimeout(()=> { if (yesBtn) yesBtn.focus(); }, 60);
      // save opener
      try { _lastTrigger = document.activeElement; } catch(e) { _lastTrigger = null; }
    });
  };

  // Close handlers
  function globalHide() {
    if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
    hidePopupContainer();
    hideOverlay();
  }

  if (overlay) overlay.addEventListener('click', globalHide);
  if (closeBtn) closeBtn.addEventListener('click', globalHide);

  // ESC handling
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      globalHide();
    }
  });

  // Helpful init log (debug)
  console.log('[inline-popup] initialized', {
    popup: !!popup, overlay: !!overlay, header: !!header, body: !!body, closeBtn: !!closeBtn
  });

})();
</script>
</body>

</html>