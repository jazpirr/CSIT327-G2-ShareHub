{# templates/admin/admindashboard.html #}
{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Admin Dashboard Â· ShareHub{% endblock %}

{% block content %}
  <div class="page-header">
    <h1>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2l7 3v5c0 5-3.58 9.74-7 11-3.42-1.26-7-6-7-11V5l7-3z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
      </svg>
      Admin Dashboard
    </h1>
    <p>Comprehensive system management and monitoring</p>
  </div>

  <div class="summary-cards" role="region" aria-label="Summary cards">
    <!-- summary cards unchanged, using template vars -->
    <div class="summary-card users-card" aria-labelledby="users-title">
      <div class="card-content">
        <div class="card-info">
          <div class="card-title" id="users-title">Total Users</div>
          <div class="card-value">{{ total_users|default:"245" }}</div>
          <div class="card-meta">
            <span class="growth-indicator">{{ users_growth|default:"+12%" }}</span>
            <span class="active-count">{{ active_users|default:"198 active" }}</span>
          </div>
        </div>
        <div class="card-icon" aria-hidden="true">
          <!-- svg -->
        </div>
      </div>
    </div>

    <div class="summary-card items-card" aria-labelledby="items-title">
      <div class="card-content">
        <div class="card-info">
          <div class="card-title" id="items-title">Total Items</div>
          <div class="card-value">{{ total_items|default:"387" }}</div>
          <div class="card-meta">
            <span class="available-count">{{ available_items|default:"302 available" }}</span>
          </div>
        </div>
        <div class="card-icon" aria-hidden="true"></div>
      </div>
    </div>

    <div class="summary-card requests-card" aria-labelledby="requests-title">
      <div class="card-content">
        <div class="card-info">
          <div class="card-title" id="requests-title">Active Requests</div>
          <div class="card-value">{{ active_requests|default:"45" }}</div>
          <div class="card-meta">
            <span class="pending-count">{{ pending_requests|default:"12 pending" }}</span>
          </div>
        </div>
        <div class="card-icon" aria-hidden="true"></div>
      </div>
    </div>

    <div class="summary-card issues-card" aria-labelledby="issues-title">
      <div class="card-content">
        <div class="card-info">
          <div class="card-title" id="issues-title">Issues</div>
          <div class="card-value">{{ issues_count|default:"11" }}</div>
          <div class="card-meta">
            <span class="overdue-count">{{ overdue|default:"8 overdue, 3 flagged" }}</span>
          </div>
        </div>
        <div class="card-icon" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <div class="action-buttons" role="tablist" aria-label="Actions">
    {# Use data-url values from APP.URLS (provided by admin_base) as fallback if template author didn't set data-url #}
    <button class="action-btn overview-btn active" data-action="overview" data-url="{{ request.path }}" role="tab" aria-selected="true">Overview</button>

    <button class="action-btn approve-btn" data-action="approve-requests" data-url="{% url 'approve_requests' %}" role="tab">Approve Requests</button>

    <button class="action-btn manage-btn" data-action="manage-users" data-url="{% url 'manage_users' %}" role="tab">Manage Users</button>

    <button class="action-btn reports-btn" data-action="view-reports" data-url="{% url 'admin_reports' %}" role="tab">View Reports</button>
  </div>

  <div class="charts-section">
    <div class="chart-container">
      <div class="chart-header">
        <h3>Borrowing Overview</h3>
        <p>Total items lent vs currently borrowed</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="borrowingChart" aria-label="Borrowing Overview chart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-header">
        <h3>Return Performance</h3>
        <p>Status of returned items</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="returnChart" aria-label="Return Performance chart"></canvas>
      </div>
    </div>
  </div>

  <div class="table-section" aria-labelledby="items-table-title">
    <div class="table-header">
      <div class="table-title">
        <h3 id="items-table-title">Items Currently Borrowed</h3>
        <span class="item-count">{{ current_borrowed_count|default:"6 Items" }}</span>
      </div>
      <p>Track all active borrowing transactions</p>
    </div>

    <div class="table-container">
      <table class="borrowed-items-table" role="table">
        <thead>
          <tr role="row">
            <th role="columnheader">Item Name</th>
            <th role="columnheader">Item Owner</th>
            <th role="columnheader">Borrower</th>
            <th role="columnheader">Return Due Date</th>
            <th role="columnheader">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for row in borrowed_items %}
          <tr role="row">
            <td>{{ row.item_name }}</td>
            <td>{{ row.item_owner }}</td>
            <td>{{ row.borrower }}</td>
            <td>
              <div class="due-date">
                <span class="date">{{ row.due_date }}</span>
                {% if row.overdue_text %}
                <span class="overdue-text">{{ row.overdue_text }}</span>
                {% elif row.remaining_text %}
                <span class="remaining-text">{{ row.remaining_text }}</span>
                {% endif %}
              </div>
            </td>
            <td>
              <span class="status-badge {{ row.status_class }}">{{ row.status_label }}</span>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5">No items currently borrowed.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {# Produce small JSON strings safely and let JS parse them using escapejs #}
  <script>
  // parse the JSON strings produced by the Django view safely
  const BORROWING_CHART = (function(){
    try { return JSON.parse('{{ borrowing_chart|safe|escapejs }}'); } catch(e){ return { labels: ['Total Lent','Currently Borrowed'], values: [0,0] }; }
  })();

  const RETURN_CHART = (function(){
    try { return JSON.parse('{{ return_chart|safe|escapejs }}'); } catch(e){ return { labels: ['On Time','Late','Missing/Lost'], values: [100,0,0] }; }
  })();

  const BORROWED_ITEMS = (function(){
    try { return JSON.parse('{{ borrowed_items_json|safe|escapejs }}'); } catch(e){ return []; }
  })();

  // provide server-known URLs for the admin navigation buttons (use your URL names)
  const ADMIN_URLS = {
    overview: "{% url 'admin_dashboard' %}",
    approveRequests: "{% url 'approve_requests' %}",
    manageUsers: "{% url 'manage_users' %}",
    viewReports: "{% url 'admin_reports' %}"
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/admindashboard.js' %}"></script>

{% endblock %}
