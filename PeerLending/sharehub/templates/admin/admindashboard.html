{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Admin Dashboard Â· ShareHub{% endblock %}

{% block head_extra %}
<!-- Include dashboard CSS only for dashboard content -->
<link rel="stylesheet" href="{% static 'css/admindashboard.css' %}" />
<!-- Font Awesome for filled (solid) icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="admin-page-containerr">
  <!-- Page Header -->
  <div class="admin-page-header">
    <div class="admin-header-content">
      <h1 class="admin-page-title">
        <i class="fas fa-shield-alt title-icon"></i>
        Admin Dashboard
      </h1>
      <p class="page-subtitle">Comprehensive system management and monitoring</p>
    </div>
    <div class="admin-header-actions">
      <div class="last-updated">
        <span class="update-indicator"></span>
        Updated just now
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card users-stat">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ total_users|default:"245" }}</div>
        <div class="stat-label">Total Users</div>
        <div class="stat-meta">
          <span class="growth positive">{{ users_growth|default:"+12%" }}</span>
          <span class="count">{{ active_users|default:"198 active" }}</span>
        </div>
      </div>
    </div>

    <div class="stat-card items-stat">
      <div class="stat-icon">
        <i class="fas fa-boxes"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ total_items|default:"387" }}</div>
        <div class="stat-label">Total Items</div>
        <div class="stat-meta">
          <span class="count">{{ available_items|default:"302 available" }}</span>
        </div>
      </div>
    </div>

    <div class="stat-card requests-stat">
      <div class="stat-icon">
        <i class="fas fa-handshake"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ active_requests|default:"45" }}</div>
        <div class="stat-label">Active Requests</div>
        <div class="stat-meta">
          <span class="count pending">{{ pending_requests|default:"12 pending" }}</span>
        </div>
      </div>
    </div>

    <div class="stat-card issues-stat">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ issues_count|default:"11" }}</div>
        <div class="stat-label">Issues</div>
        <div class="stat-meta">
          <span class="count overdue">{{ overdue|default:"8 overdue, 3 flagged" }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="chart-card">
      <div class="chart-header">
        <h3><i class="fas fa-chart-line"></i> Borrowing Overview</h3>
        <p>Total items lent vs currently borrowed</p>
      </div>
      <div class="chart-container">
        <canvas id="borrowingChart" aria-label="Borrowing Overview chart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3><i class="fas fa-chart-pie"></i> Return Performance</h3>
        <p>Status of returned items</p>
      </div>
      <div class="chart-container">
        <canvas id="returnChart" aria-label="Return Performance chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Borrowed Items Table -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <h3><i class="fas fa-list-alt"></i> Items Currently Borrowed</h3>
        <span class="item-count">{{ current_borrowed_count|default:"6" }} Items</span>
      </div>
      <p>Track all active borrowing transactions</p>
    </div>

    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th><i class="fas fa-cube"></i> Item Name</th>
            <th><i class="fas fa-user-tie"></i> Item Owner</th>
            <th><i class="fas fa-user"></i> Borrower</th>
            <th><i class="fas fa-calendar-alt"></i> Return Due Date</th>
            <th><i class="fas fa-tag"></i> Status</th>
          </tr>
        </thead>
        <tbody>
          {% for row in borrowed_items %}
          <tr class="table-row">
            <td class="item-name">{{ row.item_name }}</td>
            <td class="item-owner">{{ row.item_owner }}</td>
            <td class="borrower">{{ row.borrower }}</td>
            <td class="due-date">
              <div class="date-info">
                <span class="date">{{ row.due_date }}</span>
                {% if row.overdue_text %}
                <span class="overdue-indicator">{{ row.overdue_text }}</span>
                {% elif row.remaining_text %}
                <span class="remaining-indicator">{{ row.remaining_text }}</span>
                {% endif %}
              </div>
            </td>
            <td>
              <span class="status-tag {{ row.status_class }}">
                {% if row.status_class == 'late' %}
                  <i class="fas fa-exclamation-circle"></i>
                {% elif row.status_class == 'on-time' %}
                  <i class="fas fa-check-circle"></i>
                {% elif row.status_class == 'returned' %}
                  <i class="fas fa-check-double"></i>
                {% endif %}
                {{ row.status_label }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="empty-state">
              <div class="empty-content">
                <i class="fas fa-check-circle" style="font-size: 48px;"></i>
                <p>No items currently borrowed</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart configuration remains dynamic
document.addEventListener('DOMContentLoaded', function() {
  // Dynamically get data from Django context
  const BORROWING_CHART = (function(){
    try { 
      return JSON.parse('{{ borrowing_chart|safe|escapejs }}'); 
    } catch(e){ 
      return { 
        labels: ['Total Lent','Currently Borrowed'], 
        values: [250, 150] 
      }; 
    }
  })();

  const RETURN_CHART = (function(){
    try { 
      return JSON.parse('{{ return_chart|safe|escapejs }}'); 
    } catch(e){ 
      return { 
        labels: ['On Time','Late','Missing/Lost'], 
        values: [70, 20, 10] 
      }; 
    }
  })();

  // Chart 1: Borrowing Overview
  const borrowingCtx = document.getElementById('borrowingChart').getContext('2d');
  const borrowingChart = new Chart(borrowingCtx, {
    type: 'bar',
    data: {
      labels: BORROWING_CHART.labels,
      datasets: [{
        label: 'Items',
        data: BORROWING_CHART.values,
        backgroundColor: [
          'rgba(123, 30, 30, 0.8)',  // Maroon
          'rgba(246, 199, 0, 0.8)'   // Gold
        ],
        borderColor: [
          'rgba(123, 30, 30, 1)',
          'rgba(246, 199, 0, 1)'
        ],
        borderWidth: 1,
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: { size: 14, family: 'Inter' },
          bodyFont: { size: 14, family: 'Inter' },
          padding: 12,
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)', drawBorder: false },
          ticks: {
            font: { family: 'Inter', size: 12 },
            color: '#6B7280'
          }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { family: 'Inter', size: 12, weight: '600' },
            color: '#374151'
          }
        }
      }
    }
  });

  // Chart 2: Return Performance (Doughnut)
  const returnCtx = document.getElementById('returnChart').getContext('2d');
  const returnChart = new Chart(returnCtx, {
    type: 'doughnut',
    data: {
      labels: RETURN_CHART.labels,
      datasets: [{
        data: RETURN_CHART.values,
        backgroundColor: [
          'rgba(39, 174, 96, 0.8)',  // Success green
          'rgba(246, 199, 0, 0.8)',   // Warning yellow
          'rgba(255, 84, 89, 0.8)'    // Error red
        ],
        borderColor: [
          'rgba(39, 174, 96, 1)',
          'rgba(246, 199, 0, 1)',
          'rgba(255, 84, 89, 1)'
        ],
        borderWidth: 1,
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { family: 'Inter', size: 12 },
            color: '#374151'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: { size: 14, family: 'Inter' },
          bodyFont: { size: 14, family: 'Inter' },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}%`;
            }
          }
        }
      }
    }
  });

  // Handle window resize for better responsiveness
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      borrowingChart.resize();
      returnChart.resize();
    }, 250);
  });
});
</script>
{% endblock %}