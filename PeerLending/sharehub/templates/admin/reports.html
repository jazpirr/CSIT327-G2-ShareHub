{# templates/admin/admin_reports.html #}
{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Reported Issues Â· Admin{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/admin-reports.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="reports-container">
  <!-- Page Header -->
  <div class="reports-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-exclamation-triangle title-icon"></i>
        Reported Issues
      </h1>
      <p class="page-subtitle">Monitor and resolve reported problems in the system</p>
    </div>
    <div class="header-actions">
      <div class="reports-summary">
        <span class="total-reports">{{ reports|length }}</span>
        <span class="summary-label">Total Reports</span>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="reports-stats-grid">
    <div class="stat-card open-stat">
      <div class="stat-icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="open-count">{{ counts.open|default:0 }}</div>
        <div class="stat-label">Open Issues</div>
        <div class="stat-trend">Requiring attention</div>
      </div>
    </div>

    <div class="stat-card progress-stat">
      <div class="stat-icon">
        <i class="fas fa-spinner"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="progress-count">{{ counts.in_progress|default:0 }}</div>
        <div class="stat-label">In Progress</div>
        <div class="stat-trend">Being addressed</div>
      </div>
    </div>

    <div class="stat-card resolved-stat">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="resolved-count">{{ counts.resolved|default:0 }}</div>
        <div class="stat-label">Resolved</div>
        <div class="stat-trend">Successfully closed</div>
      </div>
    </div>

    <div class="stat-card trend-stat">
      <div class="stat-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ reports|length }}</div>
        <div class="stat-label">This Month</div>
        <div class="stat-trend">Total reports</div>
      </div>
    </div>
  </div>

  <!-- Reports Section -->
  <div class="reports-section">
    <div class="section-header">
      <div class="section-title">
        <h3><i class="fas fa-flag"></i> Issue Reports</h3>
        <div class="section-filters">
          <div class="filter-group">
            <label>Status:</label>
            <select class="filter-select" id="status-filter">
              <option value="all">All Status</option>
              <option value="open">Open</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Type:</label>
            <select class="filter-select" id="type-filter">
              <option value="all">All Types</option>
              <option value="item">Item Issues</option>
              <option value="request">Request Issues</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
      </div>
      <p>Manage and track all reported system issues</p>
    </div>

    {% if reports %}
    <div class="reports-grid">
      {% for r in reports %}
      {% with status=r.status|default:"open" %}
      <div class="report-card" data-report-id="{{ r.report_id }}" data-status="{{ status }}">
        <div class="report-header">
          <div class="report-meta">
            <span class="report-date">{{ r.created_at }}</span>
            <span class="report-id">#{{ forloop.counter }}</span>
          </div>
          <div class="report-type">
            {% if r.item_id %}
              <span class="type-badge item-type">
                <i class="fas fa-box"></i>
                Item Issue
              </span>
            {% elif r.request_id %}
              <span class="type-badge request-type">
                <i class="fas fa-handshake"></i>
                Request Issue
              </span>
            {% else %}
              <span class="type-badge other-type">
                <i class="fas fa-exclamation-triangle"></i>
                General Issue
              </span>
            {% endif %}
          </div>
        </div>

        <div class="report-content">
          <h4 class="report-title">{{ r.title }}</h4>
          <p class="report-description">{{ r.description|truncatewords:25 }}</p>
          
          <div class="report-details">
            <div class="detail-item">
              <span class="detail-label">Reference:</span>
              <span class="detail-value">
                {% if r.item_id %}
                  Item #{{ r.item_id }}
                {% elif r.request_id %}
                  Request #{{ r.request_id }}
                {% else %}
                  N/A
                {% endif %}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Reported by:</span>
              <span class="detail-value">{{ r.reported_by_email|default:r.reported_by }}</span>
            </div>
          </div>
        </div>

        <div class="report-footer">
          <div class="status-indicator">
            {% if status == "in progress" or status == "in_progress" %}
              <span class="status-badge progress">
                <i class="fas fa-spinner"></i>
                In Progress
              </span>
            {% elif status == "resolved" %}
              <span class="status-badge resolved">
                <i class="fas fa-check-circle"></i>
                Resolved
              </span>
            {% else %}
              <span class="status-badge open">
                <i class="fas fa-exclamation-circle"></i>
                Open
              </span>
            {% endif %}
          </div>

          <div class="report-actions">
            {% if status == "open" %}
              <button class="action-btn progress-btn" data-report-id="{{ r.report_id }}" data-action="in_progress">
                <i class="fas fa-spinner"></i>
                Start Progress
              </button>
            {% elif status == "in_progress" or status == "in progress" %}
              <button class="action-btn resolve-btn" data-report-id="{{ r.report_id }}" data-action="resolved">
                <i class="fas fa-check-circle"></i>
                Mark Resolved
              </button>
            {% endif %}
            
            <button class="action-btn view-btn" data-report-id="{{ r.report_id }}">
              <i class="fas fa-eye"></i>
              View Details
            </button>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>No Reported Issues</h3>
      <p>All clear! There are no reported issues at the moment. Check back later for new reports.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Report Details Modal -->
<div id="report-details-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3><i class="fas fa-file-alt"></i> Report Details</h3>
      <button class="modal-close">&times;</button>
    </header>
    <div class="modal-body">
      <div class="report-detail-content">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
    <footer class="modal-footer">
      <button class="btn btn-secondary close-modal">Close</button>
    </footer>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ reports|json_script:"reports-data" }}

<script>
// Remove all CSS from the script section and keep only JS
(function () {
  const UPDATE_URL = "{% url 'admin_update_report_status' %}";
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <span>${message}</span>
      <button class="close-notification">&times;</button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 5000);
    
    notification.querySelector('.close-notification').addEventListener('click', () => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    });
  }

  function recalcCounts() {
    let open = 0, progress = 0, resolved = 0;
    document.querySelectorAll('.report-card').forEach(card => {
      const status = card.getAttribute('data-status');
      if (status === 'open') open++;
      else if (status === 'in_progress' || status === 'in progress') progress++;
      else if (status === 'resolved') resolved++;
    });
    
    document.getElementById('open-count').textContent = open;
    document.getElementById('progress-count').textContent = progress;
    document.getElementById('resolved-count').textContent = resolved;
  }

  async function postJson(url, body) {
    const csrftoken = getCookie('csrftoken');
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(body),
        credentials: 'same-origin'
      });
      const data = await resp.json();
      return { ok: resp.ok, data };
    } catch (e) { 
      console.error('Network error', e); 
      return { ok: false, data: null, error: e }; 
    }
  }

  function updateReportStatus(card, newStatus) {
    const safeStatus = String(newStatus).replace(/\s+/g, '_').toLowerCase();
    card.setAttribute('data-status', safeStatus);
    
    const statusBadge = card.querySelector('.status-badge');
    const progressBtn = card.querySelector('.progress-btn');
    const resolveBtn = card.querySelector('.resolve-btn');
    
    // Update status badge
    statusBadge.className = `status-badge ${safeStatus}`;
    if (safeStatus === 'in_progress') {
      statusBadge.innerHTML = '<i class="fas fa-spinner"></i> In Progress';
    } else if (safeStatus === 'resolved') {
      statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Resolved';
    } else {
      statusBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Open';
    }
    
    // Update buttons
    if (safeStatus === 'open') {
      if (progressBtn) progressBtn.style.display = 'flex';
      if (resolveBtn) resolveBtn.style.display = 'none';
    } else if (safeStatus === 'in_progress') {
      if (progressBtn) progressBtn.style.display = 'none';
      if (resolveBtn) resolveBtn.style.display = 'flex';
    } else {
      if (progressBtn) progressBtn.style.display = 'none';
      if (resolveBtn) resolveBtn.style.display = 'none';
    }
    
    // Add success animation
    card.style.animation = 'pulseSuccess 0.6s ease';
    setTimeout(() => card.style.animation = '', 600);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function () {
    // Status update buttons
    document.addEventListener('click', async function (ev) {
      const btn = ev.target.closest('.progress-btn, .resolve-btn');
      if (!btn) return;
      
      ev.preventDefault();
      const reportId = btn.getAttribute('data-report-id');
      const action = btn.getAttribute('data-action');
      const card = btn.closest('.report-card');
      
      if (!reportId || !action) return;
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
      
      const resp = await postJson(UPDATE_URL, { report_id: reportId, status: action });
      
      if (!resp.ok || !resp.data) {
        showNotification('Network error while updating status', 'error');
        btn.disabled = false;
        btn.innerHTML = action === 'in_progress' ? 
          '<i class="fas fa-spinner"></i> Start Progress' :
          '<i class="fas fa-check-circle"></i> Mark Resolved';
        return;
      }
      
      if (resp.data.success) {
        updateReportStatus(card, action);
        recalcCounts();
        showNotification('Report status updated successfully', 'success');
      } else {
        showNotification('Failed to update report: ' + (resp.data.message || resp.data.error || 'Unknown error'), 'error');
        btn.disabled = false;
        btn.innerHTML = action === 'in_progress' ? 
          '<i class="fas fa-spinner"></i> Start Progress' :
          '<i class="fas fa-check-circle"></i> Mark Resolved';
      }
    });

    // Filter functionality
    const statusFilter = document.getElementById('status-filter');
    const typeFilter = document.getElementById('type-filter');
    
    if (statusFilter && typeFilter) {
      const applyFilters = () => {
        const statusValue = statusFilter.value;
        const typeValue = typeFilter.value;
        
        document.querySelectorAll('.report-card').forEach(card => {
          const cardStatus = card.getAttribute('data-status');
          const cardType = card.querySelector('.type-badge').className.includes('item-type') ? 'item' : 
                          card.querySelector('.type-badge').className.includes('request-type') ? 'request' : 'other';
          
          const statusMatch = statusValue === 'all' || cardStatus === statusValue;
          const typeMatch = typeValue === 'all' || cardType === typeValue;
          
          card.style.display = statusMatch && typeMatch ? 'block' : 'none';
        });
      };
      
      statusFilter.addEventListener('change', applyFilters);
      typeFilter.addEventListener('change', applyFilters);
    }

    // View details buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Implement view details functionality here
        showNotification('View details feature coming soon', 'info');
      });
    });

    // Modal functionality
    const modal = document.getElementById('report-details-modal');
    const closeModal = () => {
      modal.classList.add('hidden');
    };
    
    document.querySelectorAll('.modal-close, .close-modal').forEach(btn => {
      btn.addEventListener('click', closeModal);
    });
    
    document.querySelector('.modal-backdrop').addEventListener('click', closeModal);

    // Add hover effects
    document.querySelectorAll('.report-card').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-4px)';
      });
      
      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });

    // Initialize counts
    recalcCounts();
  });
})();
</script>
{% endblock %}