{# templates/admin/admin_reports.html #}
{% extends "admin/admin_base.html" %}
{% load static %}
{% block title %}Reported Issues Â· Admin{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/admin-reports.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="reports-container">
  <!-- Page Header -->
  <div class="reports-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-exclamation-triangle title-icon"></i>
        Reported Issues
      </h1>
      <p class="page-subtitle">Monitor and resolve reported problems in the system</p>
    </div>
    <div class="header-actions">
      <div class="reports-summary">
        <span class="total-reports">{{ reports|length }}</span>
        <span class="summary-label">Total Reports</span>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="reports-stats-grid">
    <div class="stat-card open-stat">
      <div class="stat-icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="open-count">{{ counts.open|default:0 }}</div>
        <div class="stat-label">Open Issues</div>
        <div class="stat-trend">Requiring attention</div>
      </div>
    </div>

    <div class="stat-card progress-stat">
      <div class="stat-icon">
        <i class="fas fa-spinner"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="progress-count">{{ counts.in_progress|default:0 }}</div>
        <div class="stat-label">In Progress</div>
        <div class="stat-trend">Being addressed</div>
      </div>
    </div>

    <div class="stat-card resolved-stat">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value" id="resolved-count">{{ counts.resolved|default:0 }}</div>
        <div class="stat-label">Resolved</div>
        <div class="stat-trend">Successfully closed</div>
      </div>
    </div>

    <div class="stat-card trend-stat">
      <div class="stat-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ reports|length }}</div>
        <div class="stat-label">This Month</div>
        <div class="stat-trend">Total reports</div>
      </div>
    </div>
  </div>

  <!-- Reports Section -->
  <div class="reports-section">
    <div class="section-header">
      <div class="section-title">
        <h3><i class="fas fa-flag"></i> Issue Reports</h3>
        <div class="section-filters">
          <div class="filter-group">
            <label>Status:</label>
            <select class="filter-select" id="status-filter">
              <option value="all">All Status</option>
              <option value="open">Open</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Type:</label>
            <select class="filter-select" id="type-filter">
              <option value="all">All Types</option>
              <option value="item">Item Issues</option>
              <option value="request">Request Issues</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
      </div>
      <p>Manage and track all reported system issues</p>
    </div>

    {% if reports %}
    <div class="reports-grid">
      {% for r in reports %}
      <!-- Debug div moved inside the loop -->
      <div style="display: none;" class="debug-report" data-id="{{ r.report_id }}"
        data-type="{{ r.report_id|default:'none'|slice:':10' }}">
        Report ID: {{ r.report_id }}, Type: {{ r.report_id|default:'none' }}
      </div>
      
      {% with status=r.status|default:"open" %}
      <div class="report-card" data-report-id="{{ r.report_id }}" data-status="{{ status }}">
        <div class="report-header">
          <div class="report-meta">
            <span class="report-date">{{ r.created_at }}</span>
            <span class="report-id">#{{ forloop.counter }}</span>
          </div>
          <div class="report-type">
            {% if r.item_id %}
            <span class="type-badge item-type">
              <i class="fas fa-box"></i>
              Item Issue
            </span>
            {% elif r.request_id %}
            <span class="type-badge request-type">
              <i class="fas fa-handshake"></i>
              Request Issue
            </span>
            {% else %}
            <span class="type-badge other-type">
              <i class="fas fa-exclamation-triangle"></i>
              General Issue
            </span>
            {% endif %}
          </div>
        </div>

        <div class="report-content">
          <h4 class="report-title">{{ r.title }}</h4>
          <p class="report-description">{{ r.description|truncatewords:25 }}</p>

          <div class="report-details">
            <div class="detail-item">
              <span class="detail-label">Reference:</span>
              <span class="detail-value">
                {% if r.item_id %}
                Item #{{ r.item_id }}
                {% elif r.request_id %}
                Request #{{ r.request_id }}
                {% else %}
                N/A
                {% endif %}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Reported by:</span>
              <span class="detail-value">{{ r.reported_by_email|default:r.reported_by }}</span>
            </div>
          </div>
        </div>

        <div class="report-footer">
          <div class="status-indicator">
            {% if status == "in progress" or status == "in_progress" %}
            <span class="status-badge progress">
              <i class="fas fa-spinner"></i>
              In Progress
            </span>
            {% elif status == "resolved" %}
            <span class="status-badge resolved">
              <i class="fas fa-check-circle"></i>
              Resolved
            </span>
            {% else %}
            <span class="status-badge open">
              <i class="fas fa-exclamation-circle"></i>
              Open
            </span>
            {% endif %}
          </div>

          <div class="report-actions">
            {% if status == "open" %}
            <button class="action-btn progress-btn" data-report-id="{{ r.report_id }}" data-action="in_progress">
              <i class="fas fa-spinner"></i>
              Start Progress
            </button>
            {% elif status == "in_progress" or status == "in progress" %}
            <button class="action-btn resolve-btn" data-report-id="{{ r.report_id }}" data-action="resolved">
              <i class="fas fa-check-circle"></i>
              Mark Resolved
            </button>
            {% endif %}

            <button class="action-btn view-btn" data-report-id="{{ r.report_id }}">
              <i class="fas fa-eye"></i>
              View Details
            </button>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>No Reported Issues</h3>
      <p>All clear! There are no reported issues at the moment. Check back later for new reports.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Report Details Modal -->
<div id="report-details-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <div class="modal-header-main">
        <h3><i class="fas fa-file-alt"></i> Report Details</h3>
      </div>
      <div class="modal-header-meta">
        <span class="modal-report-date" id="modal-report-date"></span>
      </div>
    </header>

    <div class="modal-body">
      <div class="report-detail-content">
        <!-- Loading Template -->
        <div class="detail-loading-template">
          <div class="loading-animation">
            <div class="spinner"></div>
          </div>
          <h4>Loading Report Information</h4>
          <p>Fetching details for the selected report...</p>
        </div>

        <!-- Error Template (hidden by default) -->
        <div class="detail-error-template" style="display: none;">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h4>Unable to Load Report</h4>
          <p id="error-message">The report details could not be loaded.</p>
          <button class="btn btn-retry" id="retry-load-btn">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>

        <!-- Success Template (hidden by default) -->
        <div class="detail-success-template" style="display: none;">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <footer class="modal-footer">
      <div class="modal-footer-left">
        <button class="btn btn-secondary close-modal">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
      <div class="modal-footer-right" id="modal-action-buttons">
        <!-- Action buttons will appear here when applicable -->
      </div>
    </footer>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ reports|json_script:"reports-data" }}

<script>
  console.log("ðŸŸ¢ Template script starting");
  console.log("Static URL test: {% static 'js/admin-report-details.js' %}");
</script>

<script>
  // FIXED: Use ADMIN_REPORT_DETAILS_URL (not ADMIN_REPORT_DETAILS_BASE_URL)
  window.ADMIN_REPORT_DETAILS_URL = "{% url 'admin_report_details' '0' %}".replace('0', '');
  console.log("API URL set to:", window.ADMIN_REPORT_DETAILS_URL);
</script>

<script src="{% static 'js/admin-report-details.js' %}"></script>
<script src="{% static 'js/admin-reports.js' %}"></script>

<script>
  console.log("ðŸŸ¢ After loading JS file");
  console.log("Is AdminReportDetails defined?", typeof AdminReportDetails !== 'undefined');
  console.log("Is debugReportDetails defined?", typeof debugReportDetails !== 'undefined');
</script>

<script>
  // Debug: Check if JavaScript file loaded
  console.log("admin-report-details.js loaded:", typeof AdminReportDetails !== 'undefined');
  console.log("ADMIN_REPORT_DETAILS_URL:", window.ADMIN_REPORT_DETAILS_URL);
</script>
{% endblock %}