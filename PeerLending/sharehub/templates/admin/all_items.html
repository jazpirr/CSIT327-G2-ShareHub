{% extends "admin/admin_base.html" %}
{% load static %}

{% block title %}All Items Â· Admin{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/admin_all_items.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

{# Popup styling so the base popup looks nice on this page #}

{% endblock %}

{% block content %}
<div class="admin-page-container">
  <!-- Page Header -->
  <div class="admin-page-header">
    <div class="admin-header-content">
      <h1 class="admin-page-title">
        <i class="fas fa-boxes-stacked title-icon"></i>
        All Items
      </h1>
      <p class="page-subtitle">View and manage every item in the system</p>
    </div>
    <div class="admin-header-actions">
      <div class="header-controls">
        <div class="search-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input id="itemSearch" class="search-bar" placeholder="Search title or owner..." aria-label="Search items">
        </div>
        <select id="statusFilter" class="status-filter" aria-label="Filter by status">
          <option value="all">All Status</option>
          <option value="available">Available</option>
          <option value="borrowed">Borrowed</option>
          <option value="pending">Pending</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Items Count Summary -->
  <div class="items-summary">
    <div class="summary-stat">
      <div class="summary-icon-wrapper summary-total">
        <i class="fas fa-boxes"></i>
      </div>
      <div class="summary-content">
        <span class="summary-value" id="totalCount">{{ items|length }}</span>
        <span class="summary-label">Total Items</span>
      </div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stat">
      <div class="summary-icon-wrapper summary-available">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="summary-content">
        <span class="summary-value" id="availableCount">{{ available_count|default:0 }}</span>
        <span class="summary-label">Available</span>
      </div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stat">
      <div class="summary-icon-wrapper summary-borrowed">
        <i class="fas fa-handshake"></i>
      </div>
      <div class="summary-content">
        <span class="summary-value" id="borrowedCount">{{ borrowed_count|default:0 }}</span>
        <span class="summary-label">Borrowed</span>
      </div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stat">
      <div class="summary-icon-wrapper summary-pending">
        <i class="fas fa-clock"></i>
      </div>
      <div class="summary-content">
        <span class="summary-value" id="pendingCount">{{ pending_count|default:0 }}</span>
        <span class="summary-label">Pending</span>
      </div>
    </div>
  </div>

  <!-- Items Grid -->
  <div class="items-grid-section">
    <div id="itemsGrid" class="items-grid">
      {% for it in items %}
      <div class="item-card"
           data-item-id="{{ it.item_id }}"
           data-title="{{ it.title|default:''|lower }}"
           data-owner="{{ it.owner_name|default:it.user_id|default:''|lower }}"
           data-status="{{ it.status|default:it.status_label|default:'unknown'|lower }}">

        <div class="item-image">
          {% if it.thumbnail_url %}
            <img src="{{ it.thumbnail_url }}" alt="{{ it.title }}" loading="lazy">
          {% elif it.image_url %}
            <img src="{{ it.image_url }}" alt="{{ it.title }}" loading="lazy">
          {% else %}
            <div class="no-image">
              <i class="fas fa-image"></i>
              <span>No Image</span>
            </div>
          {% endif %}
        </div>

        <div class="item-info">
          <h3 class="item-title">{{ it.title|default:"Untitled" }}</h3>
          <p class="item-owner">
            <i class="fas fa-user"></i>
            <span>{{ it.owner_name|default:it.user_id|default:"Unknown" }}</span>
          </p>
          <span class="status-badge status-{{ it.status|default:it.status_label|default:'unknown'|lower }}">
            {% if it.status|default:it.status_label|default:''|lower == 'available' %}
              <i class="fas fa-check-circle"></i>
            {% elif it.status|default:it.status_label|default:''|lower == 'borrowed' %}
              <i class="fas fa-handshake"></i>
            {% elif it.status|default:it.status_label|default:''|lower == 'pending' %}
              <i class="fas fa-clock"></i>
            {% else %}
              <i class="fas fa-info-circle"></i>
            {% endif %}
            {{ it.status|default:it.status_label|default:"Unknown"|title }}
          </span>

          <div class="item-actions">
            <button class="btn-delete-item-admin"
                    data-item-id="{{ it.item_id }}"
                    data-delete-url="{% url 'admin_delete_item' it.item_id %}"
                    aria-label="Delete {{ it.title }}">
              <i class="fas fa-trash"></i>
              <span>Delete</span>
            </button>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="empty-state">
        <i class="fas fa-box-open empty-icon"></i>
        <h2 class="empty-title">No Items Found</h2>
        <p class="empty-description">There are currently no items in the system.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{# Toast container (optional, not strictly needed by popup.js) #}
<div id="toastContainer" class="toast-container" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
  window.CSRF_TOKEN = "{{ csrf_token }}";
</script>

<script>
  window.CSRF_TOKEN = "{{ csrf_token }}";

  (function () {
    // Wait until DOM is ready
    function onReady(fn) {
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
      else fn();
    }

    onReady(function () {
      const itemsGrid = document.getElementById('itemsGrid');

      // Delegate clicks from itemsGrid so it works for dynamically-added cards too.
      if (!itemsGrid) return;

      itemsGrid.addEventListener('click', async function (e) {
        const btn = e.target.closest && e.target.closest('.btn-delete-item-admin');
        if (!btn) return;

        e.preventDefault();

        // get data from button attributes
        const itemId = btn.dataset.itemId || btn.getAttribute('data-item-id');
        const deleteUrl = btn.dataset.deleteUrl || btn.getAttribute('data-delete-url');

        // Basic guard
        if (!itemId || !deleteUrl) {
          if (typeof showMessagePopup === 'function') {
            showMessagePopup('Error', 'Missing item data. Cannot delete.', { type: 'error', autoCloseMs: 3000 });
          } else {
            alert('Missing item data. Cannot delete.');
          }
          return;
        }

        // Ensure confirm popup function exists; fallback to native confirm
        const confirmed = (typeof showConfirmPopup === 'function')
          ? await showConfirmPopup('Delete Item', 'Are you sure you want to delete this item?', 'Delete', 'Cancel')
          : confirm('Are you sure you want to delete this item?');

        if (!confirmed) return;

        // Send delete request (example using fetch). Adjust method/URL as your backend expects.
        try {
          const resp = await fetch(deleteUrl, {
            method: 'POST', // or 'DELETE' depending on your view
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': window.CSRF_TOKEN || ''
            },
            body: JSON.stringify({ item_id: itemId })
          });

          if (!resp.ok) {
            const text = await resp.text().catch(()=>null);
            throw new Error(text || `Server responded with ${resp.status}`);
          }

          // Remove the card from DOM
          const card = btn.closest('.item-card');
          if (card) card.remove();

          // Show success
          if (typeof showMessagePopup === 'function') {
            showMessagePopup('Deleted', 'Item deleted successfully.', { type: 'success', autoCloseMs: 2500 });
          } else {
            alert('Item deleted successfully.');
          }
        } catch (err) {
          console.error('Delete failed', err);
          if (typeof showMessagePopup === 'function') {
            showMessagePopup('Error', `Failed to delete item: ${err.message || err}`, { type: 'error', autoCloseMs: 5000 });
          } else {
            alert('Failed to delete item: ' + (err.message || err));
          }
        }
      });
    });
  })();
</script>



{% endblock %}
