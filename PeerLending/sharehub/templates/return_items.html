{% extends "base.html" %}
{% load static %}

{% block title %}Return Items - ShareHub{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/add-item-modal.css' %}">
<link rel="stylesheet" href="{% static 'css/return_item.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<main class="dashboard return-items-page">
  <section class="welcome">
    <h2>Return Borrowed Items</h2>
    <p>View all items you've borrowed and manage your returns.</p>
  </section>

  <section class="content-grid">

    <!-- COLLAPSIBLE BORROWED ITEMS -->
    <div class="borrowed-card" style="margin-bottom:18px;">
      <div class="borrowed-header" id="borrowedHeader" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
        <h3 style="display:flex; align-items:center; gap:8px; margin:0;">
          Your Borrowed Items
          <svg id="borrowedToggleIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7B1E1E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </h3>
        <div class="borrowed-count">{{ borrowed_items|length }}</div>
      </div>

      <div id="borrowedItemsList" style="display:none; transition: all 0.3s ease;">
        {% if borrowed_items %}
          {% for b in borrowed_items %}
            <div class="borrowed-item clickable-item" role="listitem" data-borrow-id="{{ b.request_id }}"
                 data-item-id="{{ b.item_id }}"
                 data-item-title="{{ b.item_title|escape }}"
                 data-item-image="{{ b.item_image|default:''|escape }}"
                 data-item-owner="{{ b.owner_display|escape }}"
                 data-description="{{ b.item_description|default:''|escape }}"
                 data-borrow-date="{{ b.borrow_date|default:''|escape }}"
                 data-borrow-date-human="{{ b.borrow_date_human|default:''|escape }}"
                 data-return-date="{{ b.return_date|default:''|escape }}"
                 data-return-date-human="{{ b.return_date_human|default:''|escape }}"
                 data-status="{{ b.status|default:'Borrowed'|escape }}">
              {% if b.item_image %}
                <div class="borrowed-item-thumb">
                  <img src="{{ b.item_image }}" alt="{{ b.item_title|escape }}"
                       onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'borrowed-item-thumb-placeholder\'>ðŸ“¦</div>';"/>
                </div>
              {% else %}
                <div class="borrowed-item-thumb-placeholder">ðŸ“¦</div>
              {% endif %}

              <div class="borrowed-item-info">
                <div class="borrowed-item-title">{{ b.item_title }}</div>
                <div class="borrowed-item-meta">
                  <div class="borrowed-item-owner">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>Owner: {{ b.owner_display }}</span>
                  </div>

                  <div class="borrowed-item-date">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="10"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Borrowed: {{ b.borrow_date_human }}</span>
                  </div>

                  <div class="borrowed-item-date">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2v6"/>
                      <path d="M5 22a7 7 0 0 1 14 0"/>
                    </svg>
                    <span>Return: {{ b.return_date_human|default:"(not set)" }}</span>
                  </div>
                </div>
              </div>

              <div class="return-item-actions">
                <button class="btn btn-secondary mark-returned-btn" data-borrow-id="{{ b.request_id }}" onclick="event.stopPropagation()">
                  Mark as Returned
                </button>
                <button class="btn btn-outline report-issue-btn" data-request-id="{{ b.request_id }}" data-item-id="{{ b.item_id|default:'' }}" onclick="event.stopPropagation()">
                  Report Issue
                </button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-borrowed-items">
            <p>You haven't borrowed any items yet.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- COLLAPSIBLE RETURNED ITEMS -->
    <div class="borrowed-card returned-history" style="margin-top:18px;">
      <div class="borrowed-header" id="returnedHeader" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
        <h3 style="display:flex; align-items:center; gap:8px; margin:0;">
          Returned Items
          <svg id="returnedToggleIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7B1E1E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </h3>
        <div class="borrowed-count">{{ returned_items|length }}</div>
      </div>

      <div id="returnedItemsList" style="display:none; transition: all 0.3s ease;">
        {% if returned_items %}
          {% for r in returned_items %}
            <div class="borrowed-item clickable-item" role="listitem"
                 data-item-id="{{ r.item_id }}"
                 data-item-title="{{ r.item_title|escape }}"
                 data-item-image="{{ r.item_image|default:''|escape }}"
                 data-item-owner="{{ r.owner_display|default:''|escape }}"
                 data-description="{{ r.item_description|default:''|escape }}"
                 data-borrow-date="{{ r.borrow_date|default:''|escape }}"
                 data-borrow-date-human="{{ r.borrow_date_human|default:''|escape }}"
                 data-return-date="{{ r.return_date|default:''|escape }}"
                 data-return-date-human="{{ r.return_date_human|default:''|escape }}"
                 data-status="{{ r.status|default:'Returned'|escape }}">
              {% if r.item_image %}
                <div class="borrowed-item-thumb">
                  <img src="{{ r.item_image }}" alt="{{ r.item_title|escape }}"
                       onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'borrowed-item-thumb-placeholder\'>ðŸ“¦</div>';"/>
                </div>
              {% else %}
                <div class="borrowed-item-thumb-placeholder">ðŸ“¦</div>
              {% endif %}

              <div class="borrowed-item-info">
                <div class="borrowed-item-title">{{ r.item_title }}</div>
                <div class="borrowed-item-meta">
                  <div class="borrowed-item-date">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>Borrowed: {{ r.borrow_date_human }}</span>
                  </div>

                  {% if r.return_date_human %}
                    <div class="borrowed-item-date">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                      </svg>
                      <span>Returned: {{ r.return_date_human }}</span>
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="return-item-actions">
                <span style="display:inline-block; padding:8px 16px; border-radius:8px; background:#e8f5e9; color:#2e7d32; font-size:13px; font-weight:600; text-transform:capitalize;">
                  {{ r.status|capfirst }}
                </span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-borrowed-items">
            <p>No returned items yet.</p>
          </div>
        {% endif %}
      </div>
    </div>

  </section>

</main>

<!-- Borrowed Item Details Modal -->
<div class="modal-overlay" id="borrowedItemModal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Borrowed Item Details</h2>
      <p>Information about your borrowed item</p>
    </div>

    <div class="modal-body">
      <div id="borrowedModalThumb" style="margin-bottom:12px;">
        <img id="borrowedModalImage" src="" alt="Item image" style="display:none; width:100%; max-height:240px; object-fit:cover; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.08);">
        <div id="borrowedModalImagePlaceholder" style="display:none; padding:28px; background:#fafafa; border-radius:6px; text-align:center; color:#999;">
          No image available
        </div>
      </div>

      <div class="modal-description-section">
        <label>Description</label>
        <div id="borrowedModalDescription">No description provided</div>
      </div>

      <div class="modal-info-grid">
        <div class="form-group">
          <label>Item</label>
          <div class="form-display" id="borrowedModalItemName">â€”</div>
        </div>

        <div class="form-group">
          <label>Owner</label>
          <div class="form-display" id="borrowedModalOwner">â€”</div>
        </div>

        <div class="form-group">
          <label>Borrowed On</label>
          <div class="form-display" id="borrowedModalBorrowDate">â€”</div>
        </div>

        <div class="form-group">
          <label>Return Date</label>
          <div class="form-display" id="borrowedModalReturnDate">â€”</div>
        </div>

        <div class="form-group">
          <label>Status</label>
          <div class="form-display" id="borrowedModalStatus">Borrowed</div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-cancel" id="closeBorrowedModal">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  window.MARK_RETURNED_URL = "{% url 'mark_returned' %}";
</script>

<script src="{% static 'js/report_issue.js' %}"></script>
<script src="{% static 'js/popup.js' %}"></script>
<script src="{% static 'js/confirmation_logout.js' %}"></script>
<script src="{% static 'js/add-item-modal.js' %}"></script>
<script src="{% static 'js/mark-returned.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const borrowedHeader = document.getElementById("borrowedHeader");
    const borrowedList = document.getElementById("borrowedItemsList");
    const borrowedIcon = document.getElementById("borrowedToggleIcon");
    const borrowedCountEl = document.querySelector("#borrowedHeader .borrowed-count");
    const borrowedCount = borrowedCountEl ? parseInt(borrowedCountEl.innerText || 0) : 0;

    borrowedHeader.addEventListener("click", function() {
      const isHidden = borrowedList.style.display === "none" || borrowedList.style.display === "";
      borrowedList.style.display = isHidden ? "block" : "none";
      borrowedIcon.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
      borrowedIcon.style.transition = "transform 0.25s ease";
    });

    if (borrowedCount > 0) {
      borrowedList.style.display = "block";
      borrowedIcon.style.transform = "rotate(180deg)";
    }

    const returnedHeader = document.getElementById("returnedHeader");
    const returnedList = document.getElementById("returnedItemsList");
    const returnedIcon = document.getElementById("returnedToggleIcon");
    const returnedCountEl = document.querySelector("#returnedHeader .borrowed-count");
    const returnedCount = returnedCountEl ? parseInt(returnedCountEl.innerText || 0) : 0;

    returnedHeader.addEventListener("click", function() {
      const isHidden = returnedList.style.display === "none" || returnedList.style.display === "";
      returnedList.style.display = isHidden ? "block" : "none";
      returnedIcon.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
      returnedIcon.style.transition = "transform 0.25s ease";
    });

    if (returnedCount > 0) {
      returnedList.style.display = "block";
      returnedIcon.style.transform = "rotate(180deg)";
    }

    // Modal functionality for borrowed items
    const modal = document.getElementById('borrowedItemModal');
    const closeBtn = document.getElementById('closeBorrowedModal');

    function openBorrowedModal(itemData) {
      // Set image
      const modalImage = document.getElementById('borrowedModalImage');
      const modalImagePlaceholder = document.getElementById('borrowedModalImagePlaceholder');
      
      if (itemData.image) {
        modalImage.src = itemData.image;
        modalImage.style.display = 'block';
        modalImagePlaceholder.style.display = 'none';
      } else {
        modalImage.style.display = 'none';
        modalImagePlaceholder.style.display = 'block';
      }

      // Set description
      document.getElementById('borrowedModalDescription').textContent = 
        itemData.description || 'No description provided';

      // Set item details
      document.getElementById('borrowedModalItemName').textContent = itemData.title || 'â€”';
      document.getElementById('borrowedModalOwner').textContent = itemData.owner || 'â€”';
      document.getElementById('borrowedModalBorrowDate').textContent = itemData.borrowDate || 'â€”';
      document.getElementById('borrowedModalReturnDate').textContent = itemData.returnDate || 'â€”';
      document.getElementById('borrowedModalStatus').textContent = itemData.status || 'Borrowed';

      // Show modal
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeBorrowedModal() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // Close button handler
    closeBtn.addEventListener('click', closeBorrowedModal);

    // Close on overlay click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeBorrowedModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeBorrowedModal();
      }
    });

    // Make borrowed items clickable
    document.querySelectorAll('.clickable-item').forEach(item => {
      item.style.cursor = 'pointer';
      item.addEventListener('click', function(e) {
        // Don't trigger if clicking on buttons
        if (e.target.closest('button')) {
          return;
        }

        const itemData = {
          title: this.dataset.itemTitle,
          image: this.dataset.itemImage,
          owner: this.dataset.itemOwner,
          description: this.dataset.description,
          borrowDate: this.dataset.borrowDateHuman,
          returnDate: this.dataset.returnDateHuman,
          status: this.dataset.status
        };

        openBorrowedModal(itemData);
      });
    });
  });
</script>

{# notification.js already included by base.html; no need to add it again #}
{% endblock %}