{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/my_items.css' %}">

<div class="my-items-page-wrapper page-container">
  <!-- Enhanced Header with Stats -->
  <div class="my-items-header">
    <div class="header-left">
      <h1 class="page-title" style="color:#5a0000;">My Items</h1>
      <p class="page-subtitle" style="color:#5a0000;">Manage your shared items and approve incoming requests</p>
    </div>
  </div>

  <!-- Stats Dashboard -->
  <div class="my-items-stats">
    <div class="stat-box">
      <div class="stat-icon" style="background: linear-gradient(135deg, var(--maroon-primary) 0%, var(--maroon-dark) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 id="totalItems">{{ items|length }}</h3>
        <p>Total Items</p>
      </div>
    </div>

    <div class="stat-box">
      <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 id="availableCount">{{ available_count }}</h3>
        <p>Available</p>
      </div>
    </div>

    <div class="stat-box">
      <div class="stat-icon" style="background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 id="pendingCount">{{ pending_count }}</h3>
        <p>Pending Requests</p>
      </div>
    </div>
  </div>

  <!-- Filter Toggle Buttons -->
  {% if items %}
  <div class="filter-toggle-section">
    <button class="filter-toggle-btn active" data-filter="all">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      </svg>
      All Items
    </button>
    <button class="filter-toggle-btn" data-filter="available">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"/>
        <path d="M9 12l2 2 4-4"/>
      </svg>
      Available
    </button>
    <button class="filter-toggle-btn" data-filter="borrowed">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
      </svg>
      Borrowed
    </button>
    <button class="filter-toggle-btn" data-filter="returned">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <polyline points="9 11 12 14 22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
      Returned
    </button>
  </div>

  <!-- Items Grid -->
  <div class="items-grid">
    {% for it in items %}
    <div class="item-card-enhanced" data-item-id="{{ it.item_id }}" data-status="{{ it.status_label|default:'unknown'|lower }}">

      <!-- Item Image with Status Overlay -->
      <div class="item-image-wrapper">
        <div class="item-image">
          {% if it.image_url %}
            <img src="{{ it.image_url }}" alt="{{ it.title }}">
          {% else %}
            <div class="placeholder-image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
            </div>
          {% endif %}
        </div>

        <span class="status-badge-floating
          {% if it.status_label == 'available' %}available
          {% elif it.status_label == 'borrowed' %}borrowed
          {% elif it.status_label == 'pending' %}pending
          {% elif it.status_label == 'returned' %}returned
          {% else %}unknown{% endif %}">
          <svg viewBox="0 0 8 8" fill="currentColor">
            <circle cx="4" cy="4" r="4"/>
          </svg>

          {% if it.status_label == 'available' %}
            Available
          {% elif it.status_label == 'borrowed' %}
            Borrowed
          {% elif it.status_label == 'pending' %}
            Pending
          {% elif it.status_label == 'returned' %}
            Returned
          {% else %}
            Unknown
          {% endif %}
        </span>
      </div>

      <!-- Item Details -->
      <div class="item-body-enhanced">
        <div class="item-header-row">
          <h3 class="item-title-enhanced">{{ it.title }}</h3>
          {% if it.pending_requests %}
          <span class="requests-count-badge" aria-label="pending-count">{{ it.pending_requests|length }}</span>
          {% endif %}
        </div>

        <div class="item-meta-row">
          <span class="meta-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M20 7h-9M14 17H5M17 3v18M7 3v18"/>
            </svg>
            {{ it.category }}
          </span>
          <span class="meta-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {{ it.condition }}
          </span>
        </div>

        <p class="item-description-enhanced">{{ it.description|truncatechars:120 }}</p>

        <!-- Borrowed By Section (only shown when borrowed) -->
        {% if it.status_label == 'borrowed' and it.requests %}
          {% for r in it.requests %}
            {% if r.status == 'approved' %}
              <div class="borrowed-by-section">
                <div class="borrowed-by-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </div>
                <div class="borrowed-by-info">
                  <span class="borrowed-by-label">Borrowed by</span>
                  <span class="borrowed-by-name">{{ r.requester_name }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

 
        <!-- Action Buttons -->
        <div class="item-actions-row">
          <a href="{% url 'edit_item' it.item_id %}" class="action-btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit Item
          </a>

          <!-- Report Issue button (icon only, shown when borrowed/returned) -->
          {% if it.status_label == 'borrowed' or it.status_label == 'returned' %}
          <button 
            class="action-btn-secondary report-issue-btn" 
            data-request-id="{% if it.requests and it.requests.0.request_id %}{{ it.requests.0.request_id }}{% else %}{% endif %}"
            data-item-id="{{ it.item_id }}"
            title="Report Issue" 
            type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
          </button>
          {% endif %}

          <!-- Delete button -->
          <button class="action-btn-secondary btn-delete-item" data-item-id="{{ it.item_id }}" title="Delete item" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
              <path d="M10 11v6M14 11v6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>

        <!-- Pending Requests Section (shows only pending_requests) -->
        {% if it.pending_requests %}
        <div class="requests-section-enhanced" data-requests-for="{{ it.item_id }}">
          <div class="requests-header">
            <h4>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Pending Requests
            </h4>
            <span class="requests-badge">{{ it.pending_requests|length }}</span>
          </div>

          <div class="requests-list-enhanced">
            {% for r in it.pending_requests %}
            <div class="request-item" id="req-{{ r.request_id }}" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
              <div class="requester-info">
                <div class="requester-avatar">
                  {{ r.requester_name|first|upper }}
                </div>
                <div class="requester-details">
                  <div class="requester-name">{{ r.requester_name }}</div>
                  <div class="request-time">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    {{ r.request_date_human }}
                  </div>
                </div>
              </div>
              <div class="request-actions">
                <button class="btn-approve-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}"> 
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  Approve
                </button>
                <button class="btn-deny-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                  Deny
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="no-requests-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 15h8M9 9h.01M15 9h.01"/>
          </svg>
          <p>No pending requests</p>
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Enhanced Empty State -->
  <div class="empty-state-enhanced">
    <div class="empty-icon-large">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
      </svg>
    </div>
    <h2>No Items Yet</h2>
    <p>Start sharing with the community by adding your first item</p>
  </div>
  {% endif %}
</div>

<script src="{% static 'js/report_issue.js' %}"></script>
<script src="{% static 'js/my_items.js' %}"></script>

{% endblock %}