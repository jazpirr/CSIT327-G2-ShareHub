{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/my_items.css' %}">

<div class="my-items-page-wrapper page-container">
  <div class="my-items-header">
    <div class="header-left">
      <h1 class="page-title" style="color:#5a0000;">My Items</h1>
      <p class="page-subtitle" style="color:#5a0000;">Manage your shared items and approve incoming requests</p>
    </div>
  </div>

  
  {% if items %}
  <div class="filter-toggle-section">
    <button class="filter-toggle-btn active" data-filter="all">
      <i class="fas fa-th-large"></i>
      All Items
    </button>
    <button class="filter-toggle-btn" data-filter="available">
      <i class="fas fa-check-circle"></i>
      Available
    </button>
    <button class="filter-toggle-btn" data-filter="borrowed">
      <i class="fas fa-user-friends"></i>
      Borrowed
    </button>
    <button class="filter-toggle-btn" data-filter="returned">
      <i class="fas fa-clipboard-check"></i>
      Returned
    </button>
  </div>


  <div class="items-grid">
    {% for it in items %}
    <div class="item-card-enhanced" data-item-id="{{ it.item_id }}" data-status="{{ it.status_label|default:'unknown'|lower }}">

      <div class="item-image-wrapper">
        <div class="item-image">
          {% if it.image_url %}
            <img src="{{ it.image_url }}" alt="{{ it.title }}">
          {% else %}
            <div class="placeholder-image">
              <i class="fas fa-image"></i>
            </div>
          {% endif %}
        </div>

        <span class="status-badge-floating
          {% if it.status_label == 'available' %}available
          {% elif it.status_label == 'borrowed' %}borrowed
          {% elif it.status_label == 'pending' %}pending
          {% elif it.status_label == 'returned' %}returned
          {% else %}unknown{% endif %}">
          <i class="fas fa-circle"></i>

          {% if it.status_label == 'available' %}
            Available
          {% elif it.status_label == 'borrowed' %}
            Borrowed
          {% elif it.status_label == 'pending' %}
            Pending
          {% elif it.status_label == 'returned' %}
            Returned
          {% else %}
            Unknown
          {% endif %}
        </span>
      </div>

      <!-- Item Details -->
      <div class="item-body-enhanced">
        <div class="item-header-row">
          <h3 class="item-title-enhanced">{{ it.title }}</h3>
          {% if it.pending_requests %}
          <span class="requests-count-badge" aria-label="pending-count">{{ it.pending_requests|length }}</span>
          {% endif %}
        </div>

        <div class="item-meta-row">
          <span class="meta-chip">
            <i class="fas fa-filter"></i>
            {{ it.category }}
          </span>
          <span class="meta-chip">
            <i class="fas fa-clock"></i>
            {{ it.condition }}
          </span>
        </div>

        <p class="item-description-enhanced">{{ it.description|truncatechars:120 }}</p>

        {% if it.status_label == 'borrowed' and it.requests %}
          {% for r in it.requests %}
            {% if r.status == 'approved' %}
              <div class="borrowed-by-section">
                <div class="borrowed-by-icon">
                  <i class="fas fa-user"></i>
                </div>
                <div class="borrowed-by-info">
                  <span class="borrowed-by-label">Borrowed by</span>
                  <span class="borrowed-by-name">{{ r.requester_name }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

 
        <!-- Action Buttons -->
        <div class="item-actions-row">
          <a href="{% url 'edit_item' it.item_id %}" class="action-btn-primary">
            <i class="fas fa-edit"></i>
            Edit Item
          </a>

          <!-- History button (only shown when returned) -->
          {% if it.status_label == 'returned' %}
          <button
            class="action-btn-secondary btn-history"
            type="button"
            title="View history"
            aria-label="View history"
          >
            <i class="fas fa-history"></i>
          </button>
          {% endif %}

          <!-- Report Issue button (icon only, shown when borrowed/returned) -->
          {% if it.status_label == 'borrowed' or it.status_label == 'returned' %}
          <button 
            class="action-btn-secondary report-issue-btn" 
            data-request-id="{% if it.requests and it.requests.0.request_id %}{{ it.requests.0.request_id }}{% else %}{% endif %}"
            data-item-id="{{ it.item_id }}"
            title="Report Issue" 
            type="button">
            <i class="fas fa-flag"></i>
          </button>
          {% endif %}

          <!-- Delete button -->
          <button
            class="action-btn-secondary btn-delete-item"
            data-item-id="{{ it.item_id }}"
            data-delete-url="{% url 'delete_item' it.item_id %}"
            title="Delete item"
            type="button"
          >
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>

        <!-- Hidden per-item history data (used by History modal) -->
        <div class="history-data" aria-hidden="true" style="display:none;">
          {% if it.requests %}
            {% for r in it.requests %}
              <div class="history-entry"
                   data-requester="{{ r.requester_name|default:'Unknown' }}"
                   data-request-date="{{ r.request_date_human|default:'' }}"
                   data-status="{{ r.status|default:'' }}"
                   data-return="{{ r.return|yesno:'true,false' }}">
                
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <!-- Pending Requests Section (shows only pending_requests) -->
        {% if it.pending_requests %}
        <div class="requests-section-enhanced" data-requests-for="{{ it.item_id }}">
          <div class="requests-header">
            <h4>
              <i class="fas fa-exclamation-circle"></i>
              Pending Requests
            </h4>
            <span class="requests-badge">{{ it.pending_requests|length }}</span>
          </div>

          <div class="requests-list-enhanced">
            {% for r in it.pending_requests %}
            <div class="request-item" id="req-{{ r.request_id }}" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
              <div class="requester-info">
                <div class="requester-avatar">
                  {{ r.requester_name|first|upper }}
                </div>
                <div class="requester-details">
                  <div class="requester-name">{{ r.requester_name }}</div>
                  <div class="request-time">
                    <i class="fas fa-clock"></i>
                    {{ r.request_date_human }}
                  </div>
                </div>
              </div>
              <div class="request-actions">
                <button class="btn-approve-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}"> 
                  <i class="fas fa-check"></i>
                  Approve
                </button>
                <button class="btn-deny-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
                  <i class="fas fa-times"></i>
                  Deny
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="no-requests-state">
          <i class="fas fa-comment-alt-smile"></i>
          <p>No pending requests</p>
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  
  <div class="empty-state-enhanced">
    <div class="empty-icon-large">
      <i class="fas fa-box-open"></i>
    </div>
    <h2>No Items Yet</h2>
    <p>Start sharing with the community by adding your first item</p>
  </div>
  {% endif %}

  <!-- History Modal (single modal reused for all items) -->
<div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
  <div class="modal-overlay" id="historyModalOverlay"></div>
  <div class="modal-panel" role="document" aria-labelledby="historyModalTitle" style="max-width:720px;">
    <header class="modal-header">
      <h2 id="historyModalTitle">Item history</h2>
      <button id="historyModalClose" class="modal-close-btn" aria-label="Close history">&times;</button>
    </header>
    <div class="modal-body" id="historyModalBody">
      <!-- injected entries go here -->
      <div class="history-list-empty" style="text-align:center; padding:24px;">
        <p>No history recorded for this item.</p>
      </div>
    </div>
    <footer class="modal-footer">
      <button id="historyModalCloseFooter" class="btn secondary">Close</button>
    </footer>
  </div>
</div>

<style>
.modal { position: fixed; inset: 0; z-index: 1200; display: flex; align-items: center; justify-content: center; }
.modal-overlay { position:absolute; inset:0; background: rgba(0,0,0,0.45); }
.modal-panel { position:relative; background:#fff; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:0; z-index:1201; }
.modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #eee; }
.modal-body { max-height:60vh; overflow:auto; padding:16px 20px; }
.modal-footer { display:flex; justify-content:flex-end; padding:12px 20px; border-top:1px solid #eee; }
.modal-close-btn { background:transparent; border:0; font-size:22px; line-height:1; cursor:pointer; }
.history-entry-row { display:flex; gap:12px; align-items:flex-start; padding:12px 0; border-bottom:1px dashed #eee; }
.history-entry-avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#f0f0f0; font-weight:600; }
.history-entry-content { flex:1; }
.history-entry-meta { font-size:13px; color:#666; margin-bottom:6px; }
.history-entry-status { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f3f3; }
</style>


</div>

<script src="{% static 'js/report_issue.js' %}"></script>
<script src="{% static 'js/my_items.js' %}"></script>
<script>
(function () {
  // Modal elements
  const historyModal = document.getElementById('historyModal');
  const historyModalOverlay = document.getElementById('historyModalOverlay');
  const historyModalBody = document.getElementById('historyModalBody');
  const historyModalClose = document.getElementById('historyModalClose');
  const historyModalCloseFooter = document.getElementById('historyModalCloseFooter');

  if (!historyModal || !historyModalBody) return;

  // Utility: create history entry DOM
  function buildHistoryRow(data) {
    // data: { requester, requestDate, status, returned }
    const row = document.createElement('div');
    row.className = 'history-entry-row';

    const avatar = document.createElement('div');
    avatar.className = 'history-entry-avatar';
    avatar.textContent = (data.requester && data.requester[0]) ? data.requester[0].toUpperCase() : '?';

    const content = document.createElement('div');
    content.className = 'history-entry-content';

    const meta = document.createElement('div');
    meta.className = 'history-entry-meta';
    meta.textContent = `${data.requester || 'Unknown'} • ${data.requestDate || '—'}`;

    const status = document.createElement('div');
    status.className = 'history-entry-status';
    status.textContent = (data.status || 'unknown').replace(/^./, s => s.toUpperCase());

    content.appendChild(meta);
    content.appendChild(status);

    // optional returned flag
    if (data.returned === 'true' || data.returned === true) {
      const returnedBadge = document.createElement('div');
      returnedBadge.style.marginTop = '6px';
      returnedBadge.style.fontSize = '12px';
      returnedBadge.textContent = 'Returned';
      content.appendChild(returnedBadge);
    }

    row.appendChild(avatar);
    row.appendChild(content);
    return row;
  }

  function clearModalBody() {
    // keep the "empty" message container, but clear any injected rows (except the .history-list-empty)
    historyModalBody.querySelectorAll('.history-entry-row').forEach(n => n.remove());
  }

  function openModal() {
    historyModal.style.display = 'flex';
    historyModal.setAttribute('aria-hidden', 'false');
    // trap focus simple approach: focus close button
    historyModalClose && historyModalClose.focus();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    historyModal.style.display = 'none';
    historyModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    clearModalBody();
  }

  // Delegated click: show history for the clicked item's card
  document.addEventListener('click', function (ev) {
    const btn = ev.target.closest && ev.target.closest('.btn-history');
    if (!btn) return;

    ev.preventDefault();

    // find nearest item card
    const card = btn.closest('.item-card-enhanced');
    if (!card) return;

    // find hidden history-data inside the card
    const dataContainer = card.querySelector('.history-data');
    clearModalBody();

    if (!dataContainer) {
      // show no history message
      const empty = historyModalBody.querySelector('.history-list-empty');
      if (empty) {
        empty.style.display = '';
      }
      openModal();
      return;
    }

    // gather entries
    const entries = Array.from(dataContainer.querySelectorAll('.history-entry'));
    if (!entries.length) {
      const empty = historyModalBody.querySelector('.history-list-empty');
      if (empty) empty.style.display = '';
      openModal();
      return;
    }

    // hide the empty message if present
    const empty = historyModalBody.querySelector('.history-list-empty');
    if (empty) empty.style.display = 'none';

    // build rows and append
    entries.forEach(e => {
      const entryData = {
        requester: e.dataset.requester || e.getAttribute('data-requester') || '',
        requestDate: e.dataset.requestDate || e.getAttribute('data-request-date') || '',
        status: e.dataset.status || e.getAttribute('data-status') || '',
        returned: e.dataset.return || e.getAttribute('data-return') || 'false'
      };
      const row = buildHistoryRow(entryData);
      historyModalBody.appendChild(row);
    });

    openModal();
  });

  // Close handlers
  if (historyModalClose) historyModalClose.addEventListener('click', closeModal);
  if (historyModalCloseFooter) historyModalCloseFooter.addEventListener('click', closeModal);
  if (historyModalOverlay) historyModalOverlay.addEventListener('click', closeModal);

  // escape key
  document.addEventListener('keydown', function (ev) {
    if (ev.key === 'Escape' && historyModal.getAttribute('aria-hidden') === 'false') {
      closeModal();
    }
  });

  // Prevent clicks inside panel from closing (if overlay used)
  historyModal.querySelector('.modal-panel')?.addEventListener('click', function (ev) {
    ev.stopPropagation();
  });

})();
</script>


<script>
(function(){
  const RESPOND_URL = window.RESPOND_URL || "{% url 'api_respond_request' %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Guard set: prevents double-processing of the same request id
  window.__respond_inflight = window.__respond_inflight || new Set();

  function decrementIncomingCardCount(listItemEl) {
    const card = listItemEl.closest('.item-card-enhanced') || listItemEl.closest('.content-card') || listItemEl.closest('.card');
    if (!card) return;
    const badge = card.querySelector('.requests-badge, .requests-count-badge');
    if (!badge) return;
    badge.textContent = Math.max(0, (parseInt(badge.textContent) || 0) - 1);
  }

  function removeRequestElementById(requestId){
    const el = document.querySelector(`#req-${requestId}`) || document.querySelector(`[data-request-id="${requestId}"]`);
    if (!el) return;
    try {
      el.style.transition = 'opacity 220ms ease, height 220ms ease, transform 220ms ease';
      el.style.opacity = '0';
      el.style.transform = 'translateX(12px)';
      el.style.height = el.offsetHeight + 'px';
      requestAnimationFrame(()=> {
        el.style.height = '0px';
      });
      setTimeout(()=> {
        const container = el.parentElement;
        el.remove();
        if (container && container.children.length === 0) {
          const parentCard = container.closest('.requests-section-enhanced') || container.closest('.requests-list-enhanced') || container;
          if (parentCard) {
            parentCard.innerHTML = `<div class="no-requests-state"><i class="fas fa-comment-alt-smile"></i><p>No pending requests</p></div>`;
          }
        }
      }, 280);
    } catch(e){
      try { el.remove(); } catch(_) {}
    }
  }

  async function respondRequest(requestId, action, btn) {
    if (!requestId || !btn) return;

    // If already processing this request id, don't run again
    if (window.__respond_inflight.has(requestId)) {
      return;
    }
    window.__respond_inflight.add(requestId);

    btn.disabled = true;
    const prevHtml = btn.innerHTML;
    btn.innerHTML = action === 'approve' ? '<i class="fas fa-spinner fa-spin"></i> Approving...' : '<i class="fas fa-spinner fa-spin"></i> Denying...';

    try {
      const res = await fetch(RESPOND_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ request_id: requestId, action: action })
      });

      let data = {};
      try {
        const text = await res.text();
        data = text ? JSON.parse(text) : {};
      } catch (_) {
        data = {};
      }

      if (!res.ok) {
        const serverMessage = (data && data.errors && data.errors.general && data.errors.general[0] && data.errors.general[0].message)
          || (data && data.message) || `Server error (${res.status})`;

        if (window.showMessagePopup) {
          window.showMessagePopup('Error', serverMessage, { autoCloseMs: 5000 });
        } else {
          alert('Failed: ' + serverMessage);
        }
        btn.disabled = false;
        btn.innerHTML = prevHtml;
        return;
      }

      if (data && data.success) {
        // success UI
        removeRequestElementById(requestId);
        const reqEl = document.querySelector(`#req-${requestId}`) || document.querySelector(`[data-request-id="${requestId}"]`);
        if (reqEl) decrementIncomingCardCount(reqEl);

        if (window.showMessagePopup) {
          window.showMessagePopup('Success', action === 'approve' ? 'Request approved.' : 'Request denied.', { autoCloseMs: 3000 });
        } else {
          alert(action === 'approve' ? 'Request approved.' : 'Request denied.');
        }
        return;
      }

      // fallback: server returned ok but not success
      const serverMessage = (data && data.message) || 'Failed to process request.';
      if (window.showMessagePopup) {
        window.showMessagePopup('Error', serverMessage, { autoCloseMs: 5000 });
      } else {
        alert(serverMessage);
      }
      btn.disabled = false;
      btn.innerHTML = prevHtml;
    } catch (err) {
      console.error('respondRequest network error', err);
      if (window.showMessagePopup) {
        window.showMessagePopup('Network error', 'Network error while processing action.', { autoCloseMs: 5000 });
      } else {
        alert('Network error while processing action.');
      }
      btn.disabled = false;
      btn.innerHTML = prevHtml;
    } finally {
      // Clear the inflight guard so same requestId can be processed again later
      window.__respond_inflight.delete(requestId);
    }
  }

  // delegated click listener
  document.addEventListener('click', function(e){
    // stopImmediatePropagation to reduce chance of other handlers firing for same element
    const approveBtn = e.target.closest && e.target.closest('.btn-approve-new');
    const denyBtn = e.target.closest && e.target.closest('.btn-deny-new');

    if (approveBtn) {
      // prevent other listeners from receiving this click (if those listeners call stopImmediatePropagation as well)
      try { e.stopImmediatePropagation(); } catch(_) {}
      const requestId = approveBtn.getAttribute('data-request-id') || approveBtn.dataset.requestId;
      respondRequest(requestId, 'approve', approveBtn);
    } else if (denyBtn) {
      try { e.stopImmediatePropagation(); } catch(_) {}
      const requestId = denyBtn.getAttribute('data-request-id') || denyBtn.dataset.requestId;
      respondRequest(requestId, 'deny', denyBtn);
    }
  });

  // normalize counts on load
  document.addEventListener('DOMContentLoaded', function(){
    try {
      document.querySelectorAll('.requests-section-enhanced').forEach(section => {
        const badge = section.querySelector('.requests-badge');
        const count = section.querySelectorAll('.request-item').length;
        if (badge) badge.textContent = count;
      });
    } catch(e){ /* ignore */ }
  });
})();
</script>

{% endblock %}