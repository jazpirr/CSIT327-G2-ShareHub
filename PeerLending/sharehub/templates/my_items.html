{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/my_items.css' %}">

<div class="my-items-page-wrapper page-container">
  <!-- Enhanced Header with Stats -->
  <div class="my-items-header">
    <div class="header-left">
      <h1 class="page-title" style="color:#5a0000;">My Items</h1>
      <p class="page-subtitle" style="color:#5a0000;">Manage your shared items and approve incoming requests</p>
    </div>
  </div>

  
  <!-- Filter Toggle Buttons -->
  {% if items %}
  <div class="filter-toggle-section">
    <button class="filter-toggle-btn active" data-filter="all">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      </svg>
      All Items
    </button>
    <button class="filter-toggle-btn" data-filter="available">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"/>
        <path d="M9 12l2 2 4-4"/>
      </svg>
      Available
    </button>
    <button class="filter-toggle-btn" data-filter="borrowed">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
      </svg>
      Borrowed
    </button>
    <button class="filter-toggle-btn" data-filter="returned">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <polyline points="9 11 12 14 22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
      Returned
    </button>
  </div>

  <!-- Items Grid -->
  <div class="items-grid">
    {% for it in items %}
    <div class="item-card-enhanced" data-item-id="{{ it.item_id }}" data-status="{{ it.status_label|default:'unknown'|lower }}">

      <!-- Item Image with Status Overlay -->
      <div class="item-image-wrapper">
        <div class="item-image">
          {% if it.image_url %}
            <img src="{{ it.image_url }}" alt="{{ it.title }}">
          {% else %}
            <div class="placeholder-image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
            </div>
          {% endif %}
        </div>

        <span class="status-badge-floating
          {% if it.status_label == 'available' %}available
          {% elif it.status_label == 'borrowed' %}borrowed
          {% elif it.status_label == 'pending' %}pending
          {% elif it.status_label == 'returned' %}returned
          {% else %}unknown{% endif %}">
          <svg viewBox="0 0 8 8" fill="currentColor">
            <circle cx="4" cy="4" r="4"/>
          </svg>

          {% if it.status_label == 'available' %}
            Available
          {% elif it.status_label == 'borrowed' %}
            Borrowed
          {% elif it.status_label == 'pending' %}
            Pending
          {% elif it.status_label == 'returned' %}
            Returned
          {% else %}
            Unknown
          {% endif %}
        </span>
      </div>

      <!-- Item Details -->
      <div class="item-body-enhanced">
        <div class="item-header-row">
          <h3 class="item-title-enhanced">{{ it.title }}</h3>
          {% if it.pending_requests %}
          <span class="requests-count-badge" aria-label="pending-count">{{ it.pending_requests|length }}</span>
          {% endif %}
        </div>

        <div class="item-meta-row">
          <span class="meta-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M20 7h-9M14 17H5M17 3v18M7 3v18"/>
            </svg>
            {{ it.category }}
          </span>
          <span class="meta-chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {{ it.condition }}
          </span>
        </div>

        <p class="item-description-enhanced">{{ it.description|truncatechars:120 }}</p>

        <!-- Borrowed By Section (only shown when borrowed) -->
        {% if it.status_label == 'borrowed' and it.requests %}
          {% for r in it.requests %}
            {% if r.status == 'approved' %}
              <div class="borrowed-by-section">
                <div class="borrowed-by-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </div>
                <div class="borrowed-by-info">
                  <span class="borrowed-by-label">Borrowed by</span>
                  <span class="borrowed-by-name">{{ r.requester_name }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

 
        <!-- Action Buttons -->
        <div class="item-actions-row">
          <a href="{% url 'edit_item' it.item_id %}" class="action-btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit Item
          </a>

          <!-- History button (only shown when returned) -->
          {% if it.status_label == 'returned' %}
          <button
            class="action-btn-secondary btn-history"
            type="button"
            title="View history"
            aria-label="View history"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </button>
          {% endif %}

          <!-- Report Issue button (icon only, shown when borrowed/returned) -->
          {% if it.status_label == 'borrowed' or it.status_label == 'returned' %}
          <button 
            class="action-btn-secondary report-issue-btn" 
            data-request-id="{% if it.requests and it.requests.0.request_id %}{{ it.requests.0.request_id }}{% else %}{% endif %}"
            data-item-id="{{ it.item_id }}"
            title="Report Issue" 
            type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
              <line x1="4" y1="22" x2="4" y2="15"/>
            </svg>
          </button>
          {% endif %}

          <!-- Delete button -->
          <button class="action-btn-secondary btn-delete-item" data-item-id="{{ it.item_id }}" title="Delete item" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
          </button>
        </div>

        <!-- Hidden per-item history data (used by History modal) -->
        <div class="history-data" aria-hidden="true" style="display:none;">
          {% if it.requests %}
            {% for r in it.requests %}
              <div class="history-entry"
                   data-requester="{{ r.requester_name|default:'Unknown' }}"
                   data-request-date="{{ r.request_date_human|default:'' }}"
                   data-status="{{ r.status|default:'' }}"
                   data-return="{{ r.return|yesno:'true,false' }}">
                
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <!-- Pending Requests Section (shows only pending_requests) -->
        {% if it.pending_requests %}
        <div class="requests-section-enhanced" data-requests-for="{{ it.item_id }}">
          <div class="requests-header">
            <h4>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Pending Requests
            </h4>
            <span class="requests-badge">{{ it.pending_requests|length }}</span>
          </div>

          <div class="requests-list-enhanced">
            {% for r in it.pending_requests %}
            <div class="request-item" id="req-{{ r.request_id }}" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
              <div class="requester-info">
                <div class="requester-avatar">
                  {{ r.requester_name|first|upper }}
                </div>
                <div class="requester-details">
                  <div class="requester-name">{{ r.requester_name }}</div>
                  <div class="request-time">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    {{ r.request_date_human }}
                  </div>
                </div>
              </div>
              <div class="request-actions">
                <button class="btn-approve-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}"> 
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  Approve
                </button>
                <button class="btn-deny-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                  Deny
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="no-requests-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 15h8M9 9h.01M15 9h.01"/>
          </svg>
          <p>No pending requests</p>
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Enhanced Empty State -->
  <div class="empty-state-enhanced">
    <div class="empty-icon-large">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
      </svg>
    </div>
    <h2>No Items Yet</h2>
    <p>Start sharing with the community by adding your first item</p>
  </div>
  {% endif %}

  <!-- History Modal (single modal reused for all items) -->
<div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
  <div class="modal-overlay" id="historyModalOverlay"></div>
  <div class="modal-panel" role="document" aria-labelledby="historyModalTitle" style="max-width:720px;">
    <header class="modal-header">
      <h2 id="historyModalTitle">Item history</h2>
      <button id="historyModalClose" class="modal-close-btn" aria-label="Close history">&times;</button>
    </header>
    <div class="modal-body" id="historyModalBody">
      <!-- injected entries go here -->
      <div class="history-list-empty" style="text-align:center; padding:24px;">
        <p>No history recorded for this item.</p>
      </div>
    </div>
    <footer class="modal-footer">
      <button id="historyModalCloseFooter" class="btn secondary">Close</button>
    </footer>
  </div>
</div>

<!-- Minimal modal CSS (place in your my_items.css if you prefer) -->
<style>
/* modal basics */
.modal { position: fixed; inset: 0; z-index: 1200; display: flex; align-items: center; justify-content: center; }
.modal-overlay { position:absolute; inset:0; background: rgba(0,0,0,0.45); }
.modal-panel { position:relative; background:#fff; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:0; z-index:1201; }
.modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #eee; }
.modal-body { max-height:60vh; overflow:auto; padding:16px 20px; }
.modal-footer { display:flex; justify-content:flex-end; padding:12px 20px; border-top:1px solid #eee; }
.modal-close-btn { background:transparent; border:0; font-size:22px; line-height:1; cursor:pointer; }
.history-entry-row { display:flex; gap:12px; align-items:flex-start; padding:12px 0; border-bottom:1px dashed #eee; }
.history-entry-avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#f0f0f0; font-weight:600; }
.history-entry-content { flex:1; }
.history-entry-meta { font-size:13px; color:#666; margin-bottom:6px; }
.history-entry-status { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f3f3; }
</style>


</div>

<script src="{% static 'js/report_issue.js' %}"></script>
<script src="{% static 'js/my_items.js' %}"></script>

{% endblock %}