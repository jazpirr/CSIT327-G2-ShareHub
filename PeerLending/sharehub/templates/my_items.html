{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/my_items.css' %}">

<div class="my-items-page-wrapper page-container">
  <div class="my-items-header">
    <div class="header-left">
      <h1 class="page-title" style="color:#5a0000;">My Items</h1>
      <p class="page-subtitle" style="color:#5a0000;">Manage your shared items and approve incoming requests</p>
    </div>
  </div>

  
  {% if items %}
  <div class="filter-toggle-section">
    <button class="filter-toggle-btn active" data-filter="all">
      <i class="fas fa-th-large"></i>
      All Items
    </button>
    <button class="filter-toggle-btn" data-filter="available">
      <i class="fas fa-check-circle"></i>
      Available
    </button>
    <button class="filter-toggle-btn" data-filter="borrowed">
      <i class="fas fa-user-friends"></i>
      Borrowed
    </button>
    <button class="filter-toggle-btn" data-filter="returned">
      <i class="fas fa-clipboard-check"></i>
      Returned
    </button>
  </div>


  <div class="items-grid">
    {% for it in items %}
    <div class="item-card-enhanced" data-item-id="{{ it.item_id }}" data-status="{{ it.status_label|default:'unknown'|lower }}">

      <div class="item-image-wrapper">
        <div class="item-image">
          {% if it.image_url %}
            <img src="{{ it.image_url }}" alt="{{ it.title }}">
          {% else %}
            <div class="placeholder-image">
              <i class="fas fa-image"></i>
            </div>
          {% endif %}
        </div>

        <span class="status-badge-floating
          {% if it.status_label == 'available' %}available
          {% elif it.status_label == 'borrowed' %}borrowed
          {% elif it.status_label == 'pending' %}pending
          {% elif it.status_label == 'returned' %}returned
          {% else %}unknown{% endif %}">
          <i class="fas fa-circle"></i>

          {% if it.status_label == 'available' %}
            Available
          {% elif it.status_label == 'borrowed' %}
            Borrowed
          {% elif it.status_label == 'pending' %}
            Pending
          {% elif it.status_label == 'returned' %}
            Returned
          {% else %}
            Unknown
          {% endif %}
        </span>
      </div>

      <!-- Item Details -->
      <div class="item-body-enhanced">
        <div class="item-header-row">
          <h3 class="item-title-enhanced">{{ it.title }}</h3>
          {% if it.pending_requests %}
          <span class="requests-count-badge" aria-label="pending-count">{{ it.pending_requests|length }}</span>
          {% endif %}
        </div>

        <div class="item-meta-row">
          <span class="meta-chip">
            <i class="fas fa-filter"></i>
            {{ it.category }}
          </span>
          <span class="meta-chip">
            <i class="fas fa-clock"></i>
            {{ it.condition }}
          </span>
        </div>

        <p class="item-description-enhanced">{{ it.description|truncatechars:120 }}</p>

        {% if it.status_label == 'borrowed' and it.requests %}
          {% for r in it.requests %}
            {% if r.status == 'approved' %}
              <div class="borrowed-by-section">
                <div class="borrowed-by-icon">
                  <i class="fas fa-user"></i>
                </div>
                <div class="borrowed-by-info">
                  <span class="borrowed-by-label">Borrowed by</span>
                  <span class="borrowed-by-name">{{ r.requester_name }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

 
        <!-- Action Buttons -->
        <div class="item-actions-row">
          <a href="{% url 'edit_item' it.item_id %}" class="action-btn-primary">
            <i class="fas fa-edit"></i>
            Edit Item
          </a>

          <!-- History button (only shown when returned) -->
          {% if it.status_label == 'returned' %}
          <button
            class="action-btn-secondary btn-history"
            type="button"
            title="View history"
            aria-label="View history"
          >
            <i class="fas fa-history"></i>
          </button>
          {% endif %}

          <!-- Report Issue button (icon only, shown when borrowed/returned) -->
          {% if it.status_label == 'borrowed' or it.status_label == 'returned' %}
          <button 
            class="action-btn-secondary report-issue-btn" 
            data-request-id="{% if it.requests and it.requests.0.request_id %}{{ it.requests.0.request_id }}{% else %}{% endif %}"
            data-item-id="{{ it.item_id }}"
            title="Report Issue" 
            type="button">
            <i class="fas fa-flag"></i>
          </button>
          {% endif %}

          <!-- Delete button -->
          <button
            class="action-btn-secondary btn-delete-item"
            data-item-id="{{ it.item_id }}"
            data-delete-url="{% url 'delete_item' it.item_id %}"
            title="Delete item"
            type="button"
          >
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>

        <!-- Hidden per-item history data (used by History modal) -->
        <div class="history-data" aria-hidden="true" style="display:none;">
          {% if it.requests %}
            {% for r in it.requests %}
              <div class="history-entry"
                   data-requester="{{ r.requester_name|default:'Unknown' }}"
                   data-request-date="{{ r.request_date_human|default:'' }}"
                   data-status="{{ r.status|default:'' }}"
                   data-return="{{ r.return|yesno:'true,false' }}">
                
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <!-- Pending Requests Section (shows only pending_requests) -->
        {% if it.pending_requests %}
        <div class="requests-section-enhanced" data-requests-for="{{ it.item_id }}">
          <div class="requests-header">
            <h4>
              <i class="fas fa-exclamation-circle"></i>
              Pending Requests
            </h4>
            <span class="requests-badge">{{ it.pending_requests|length }}</span>
          </div>

          <div class="requests-list-enhanced">
            {% for r in it.pending_requests %}
            <div class="request-item" id="req-{{ r.request_id }}" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
              <div class="requester-info">
                <div class="requester-avatar">
                  {{ r.requester_name|first|upper }}
                </div>
                <div class="requester-details">
                  <div class="requester-name">{{ r.requester_name }}</div>
                  <div class="request-time">
                    <i class="fas fa-clock"></i>
                    {{ r.request_date_human }}
                  </div>
                </div>
              </div>
              <div class="request-actions">
                <button class="btn-approve-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}"> 
                  <i class="fas fa-check"></i>
                  Approve
                </button>
                <button class="btn-deny-new" data-request-id="{{ r.request_id }}" data-item-id="{{ it.item_id }}">
                  <i class="fas fa-times"></i>
                  Deny
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% else %}
        <div class="no-requests-state">
          <i class="fas fa-comment-alt-smile"></i>
          <p>No pending requests</p>
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  
  <div class="empty-state-enhanced">
    <div class="empty-icon-large">
      <i class="fas fa-box-open"></i>
    </div>
    <h2>No Items Yet</h2>
    <p>Start sharing with the community by adding your first item</p>
  </div>
  {% endif %}

  <!-- History Modal (single modal reused for all items) -->
<div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
  <div class="modal-overlay" id="historyModalOverlay"></div>
  <div class="modal-panel" role="document" aria-labelledby="historyModalTitle" style="max-width:720px;">
    <header class="modal-header">
      <h2 id="historyModalTitle">Item history</h2>
      <button id="historyModalClose" class="modal-close-btn" aria-label="Close history">&times;</button>
    </header>
    <div class="modal-body" id="historyModalBody">
      <!-- injected entries go here -->
      <div class="history-list-empty" style="text-align:center; padding:24px;">
        <p>No history recorded for this item.</p>
      </div>
    </div>
    <footer class="modal-footer">
      <button id="historyModalCloseFooter" class="btn secondary">Close</button>
    </footer>
  </div>
</div>

<style>
.modal { position: fixed; inset: 0; z-index: 1200; display: flex; align-items: center; justify-content: center; }
.modal-overlay { position:absolute; inset:0; background: rgba(0,0,0,0.45); }
.modal-panel { position:relative; background:#fff; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:0; z-index:1201; }
.modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #eee; }
.modal-body { max-height:60vh; overflow:auto; padding:16px 20px; }
.modal-footer { display:flex; justify-content:flex-end; padding:12px 20px; border-top:1px solid #eee; }
.modal-close-btn { background:transparent; border:0; font-size:22px; line-height:1; cursor:pointer; }
.history-entry-row { display:flex; gap:12px; align-items:flex-start; padding:12px 0; border-bottom:1px dashed #eee; }
.history-entry-avatar { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#f0f0f0; font-weight:600; }
.history-entry-content { flex:1; }
.history-entry-meta { font-size:13px; color:#666; margin-bottom:6px; }
.history-entry-status { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f3f3; }
</style>


</div>

<script src="{% static 'js/report_issue.js' %}"></script>
<script src="{% static 'js/my_items.js' %}"></script>

{% endblock %}